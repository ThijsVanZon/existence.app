<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>2015-2025</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
</head>

<body>
  <a href="{{ url_for('index') }}"><h1>Timeline</h1></a>
  <nav class="timeline" aria-label="enlightenment timeline">
    <div class="sub-decade-container" id="decade-2015">
      <span class="sub-decade" id="sub-decade-2015">2015</span>
    </div>
    <div class="main-decade-container" id="decade-2020">
      <span class="main-decade" id="main-decade-2020">ENLIGHTENMENT</span>
    </div>
    <div class="sub-decade-container" id="decade-2025">
      <span class="sub-decade" id="sub-decade-2025">2025</span>
    </div>
  </nav>

  <h2>Scraped Jobs Per Sleeve</h2>
  <section class="scrape-toolbar" hidden>
    <p class="toolbar-hint">Run any sleeve with one shared filter setup. This keeps comparisons fair across sleeves and avoids repetitive toggling.</p>
    <p class="toolbar-hint" id="profile-hint">Active profile: MVP (Indeed NL only, no auto failover).</p>
    <div class="toolbar-grid">
      <div class="toolbar-field">
        <label for="global-location">Location scope</label>
        <select id="global-location">
          <option value="nl_only">Netherlands focus</option>
          <option value="nl_eu">Netherlands + EU remote</option>
          <option value="global">Global</option>
        </select>
      </div>

      <div class="toolbar-field">
        <label>Results view</label>
        <p class="toolbar-static">10 per pagina. Gebruik per sleeve Next/Previous om door alle resultaten te bladeren.</p>
      </div>

      <div class="toolbar-field toolbar-checks">
        <label class="control-inline">
          <input type="checkbox" id="global-strict" checked>
          Strict sleeve matching
        </label>
        <label class="control-inline">
          <input type="checkbox" id="global-cache" checked>
          Use cache (faster)
        </label>
        <label class="control-inline" id="global-failover-wrap">
          <input type="checkbox" id="global-failover">
          Auto failover sources
        </label>
      </div>
    </div>

    <div class="toolbar-field">
      <div class="source-title">Enabled Sources</div>
      <div id="global-sources" class="source-toggle-group"></div>
      <div id="source-note" class="toolbar-note"></div>
      <details id="unavailable-sources" class="unavailable-sources" hidden>
        <summary>Unavailable sources</summary>
        <div id="unavailable-source-list"></div>
      </details>
    </div>
  </section>

  <div class="sleeve-grid">
    <section class="sleeve-panel" id="panel-A">
      <h3>
        <span class="sleeve-header-code">Career Sleeve A</span>
        <span class="sleeve-header-name">Music Events & Festivals</span>
      </h3>
      <p class="sleeve-tagline">International live music productions where creative intent and on-site operations align across crews, artists, and stakeholders.</p>
      <label class="extra-terms-label" for="extra-terms-A">Extra zoekwoorden (comma separated)</label>
      <input id="extra-terms-A" class="extra-terms-input" type="text" placeholder="bijv. touring, artist liaison, festival operations">
      <button type="button" onclick="startScraping('A')">Scrape Career Sleeve A</button>
      <p id="status-A" aria-live="polite"></p>
      <div id="summary-A" class="sleeve-summary"></div>
      <div id="error-A" class="error" style="display: none;"></div>
      <div id="results-A"></div>
      <div id="pager-A" class="results-pager" hidden></div>
    </section>

    <section class="sleeve-panel" id="panel-B">
      <h3>
        <span class="sleeve-header-code">Career Sleeve B</span>
        <span class="sleeve-header-name">Theme Parks & Destinations</span>
      </h3>
      <p class="sleeve-tagline">Theme parks and immersive destinations: experience delivery plus operations discipline for safe, repeatable show quality.</p>
      <label class="extra-terms-label" for="extra-terms-B">Extra zoekwoorden (comma separated)</label>
      <input id="extra-terms-B" class="extra-terms-input" type="text" placeholder="bijv. attractions ops, guest flow, show quality">
      <button type="button" onclick="startScraping('B')">Scrape Career Sleeve B</button>
      <p id="status-B" aria-live="polite"></p>
      <div id="summary-B" class="sleeve-summary"></div>
      <div id="error-B" class="error" style="display: none;"></div>
      <div id="results-B"></div>
      <div id="pager-B" class="results-pager" hidden></div>
    </section>

    <section class="sleeve-panel" id="panel-C">
      <h3>
        <span class="sleeve-header-code">Career Sleeve C</span>
        <span class="sleeve-header-name">Data Centers & Facilities</span>
      </h3>
      <p class="sleeve-tagline">AI/compute datacenter and facilities ops focused on uptime, safety, scaling, and execution across sites.</p>
      <label class="extra-terms-label" for="extra-terms-C">Extra zoekwoorden (comma separated)</label>
      <input id="extra-terms-C" class="extra-terms-input" type="text" placeholder="bijv. data center, commissioning, uptime, ai infrastructure">
      <button type="button" onclick="startScraping('C')">Scrape Career Sleeve C</button>
      <p id="status-C" aria-live="polite"></p>
      <div id="summary-C" class="sleeve-summary"></div>
      <div id="error-C" class="error" style="display: none;"></div>
      <div id="results-C"></div>
      <div id="pager-C" class="results-pager" hidden></div>
    </section>

    <section class="sleeve-panel" id="panel-D">
      <h3>
        <span class="sleeve-header-code">Career Sleeve D</span>
        <span class="sleeve-header-name">Supply Chains & Ecosystems</span>
      </h3>
      <p class="sleeve-tagline">International supply chains and ecosystems: vendor/partner alignment, rollout execution, and reliable cross-site flow.</p>
      <label class="extra-terms-label" for="extra-terms-D">Extra zoekwoorden (comma separated)</label>
      <input id="extra-terms-D" class="extra-terms-input" type="text" placeholder="bijv. vendor operations, rollout, logistics flow">
      <button type="button" onclick="startScraping('D')">Scrape Career Sleeve D</button>
      <p id="status-D" aria-live="polite"></p>
      <div id="summary-D" class="sleeve-summary"></div>
      <div id="error-D" class="error" style="display: none;"></div>
      <div id="results-D"></div>
      <div id="pager-D" class="results-pager" hidden></div>
    </section>

    <section class="sleeve-panel" id="panel-E">
      <h3>
        <span class="sleeve-header-code">Career Sleeve E</span>
        <span class="sleeve-header-name">Custom / User-defined Sleeve</span>
      </h3>
      <p class="sleeve-tagline">Custom sleeve configured by the user with role archetypes, keywords, locations, and exclusions.</p>
      <label class="extra-terms-label" for="extra-terms-E">Extra zoekwoorden (comma separated)</label>
      <input id="extra-terms-E" class="extra-terms-input" type="text" placeholder="bijv. role archetypes, must-haves, exclusions, locations">
      <button type="button" onclick="startScraping('E')">Scrape Career Sleeve E</button>
      <p id="status-E" aria-live="polite"></p>
      <div id="summary-E" class="sleeve-summary"></div>
      <div id="error-E" class="error" style="display: none;"></div>
      <div id="results-E"></div>
      <div id="pager-E" class="results-pager" hidden></div>
    </section>
  </div>

  <script>
    const sleeveKeys = ['A', 'B', 'C', 'D', 'E'];
    const RESULTS_PER_PAGE = 10;
    const DEFAULT_FETCH_LIMIT = 200;
    const sleeveMeta = {
      A: {
        name: 'Music Events & Festivals',
        tagline: 'International live music productions where creative intent and on-site operations align across crews, artists, and stakeholders.'
      },
      B: {
        name: 'Theme Parks & Destinations',
        tagline: 'Theme parks and immersive destinations: experience delivery plus operations discipline for safe, repeatable show quality.'
      },
      C: {
        name: 'Data Centers & Facilities',
        tagline: 'AI/compute datacenter and facilities ops focused on uptime, safety, scaling, and execution across sites.'
      },
      D: {
        name: 'Supply Chains & Ecosystems',
        tagline: 'International supply chains and ecosystems: vendor/partner alignment, rollout execution, and reliable cross-site flow.'
      },
      E: {
        name: 'Custom / User-defined Sleeve',
        tagline: 'Custom sleeve configured by the user with role archetypes, keywords, locations, and exclusions.'
      }
    };
    const sleeveControllers = {};
    const fallbackConfig = {
      profile: 'mvp',
      sources: [
        { id: 'indeed_web', label: 'Indeed (direct scraping)', available: true, default_enabled: true, reason: '' },
      ],
      defaults: {
        sources: ['indeed_web'],
        location_mode: 'nl_only',
        strict: false,
        max_results: DEFAULT_FETCH_LIMIT,
        failover: false,
        use_cache: true
      },
      location_modes: [
        { id: 'nl_only', label: 'Netherlands focus' },
      ],
    };
    let scrapeConfig = fallbackConfig;
    const sleevePagination = Object.fromEntries(
      sleeveKeys.map((key) => [key, { jobs: [], page: 1 }])
    );

    function sourceLabelMap() {
      const mapping = {};
      (scrapeConfig.sources || []).forEach(source => {
        mapping[source.id] = source.label;
      });
      return mapping;
    }

    function resolveWorkMode(job) {
      const explicit = String(job.work_mode || '').trim();
      if (explicit) {
        return explicit;
      }
      const text = `${job.location || ''} ${job.snippet || ''} ${job.full_description || ''}`.toLowerCase();
      if (text.includes('hybrid') || text.includes('hybride')) {
        return 'Hybrid';
      }
      if (
        text.includes('remote') ||
        text.includes('op afstand') ||
        text.includes('thuiswerk') ||
        text.includes('werk vanuit huis')
      ) {
        return 'Remote';
      }
      if (
        text.includes('on-site') ||
        text.includes('onsite') ||
        text.includes('on site') ||
        text.includes('op locatie') ||
        text.includes('op kantoor')
      ) {
        return 'On-site';
      }
      return 'Unknown';
    }

    function createBadge(className, text) {
      const badge = document.createElement('span');
      badge.className = className;
      badge.textContent = text;
      return badge;
    }

    function isValidHttpUrl(url) {
      const value = String(url || '').trim();
      return /^https?:\/\//i.test(value);
    }

    function isIndeedUrl(url) {
      if (!isValidHttpUrl(url)) {
        return false;
      }
      try {
        return new URL(url).hostname.toLowerCase().includes('indeed.');
      } catch (error) {
        return false;
      }
    }

    function buildIndeedPostingFallbackUrl(job) {
      const company = String(job?.company || '').trim();
      const title = String(job?.title || '').trim();
      const query = `${title} ${company}`.trim() || 'vacature';
      return `https://nl.indeed.com/jobs?q=${encodeURIComponent(query)}&l=${encodeURIComponent('Nederland')}`;
    }

    function extractExternalFromIndeedUrl(url) {
      if (!isValidHttpUrl(url)) {
        return '';
      }
      try {
        const parsed = new URL(url);
        const redirectKeys = ['adurl', 'dest', 'destination', 'redirect', 'redirecturl', 'url', 'u', 'target'];
        for (const key of redirectKeys) {
          const raw = parsed.searchParams.get(key);
          if (!raw) {
            continue;
          }
          const decoded = decodeURIComponent(decodeURIComponent(raw));
          if (!isValidHttpUrl(decoded)) {
            continue;
          }
          const host = new URL(decoded).hostname.toLowerCase();
          if (!host.includes('indeed.')) {
            return decoded;
          }
        }
      } catch (error) {
        return '';
      }
      return '';
    }

    function createActionLink(label, href, extraClass = '', enabled = true) {
      const link = document.createElement('a');
      link.className = `job-link-btn ${extraClass}`.trim();
      link.href = enabled ? href : '#';
      link.textContent = label;
      if (enabled) {
        link.target = '_blank';
        link.rel = 'noopener noreferrer';
      } else {
        link.classList.add('job-link-disabled');
        link.setAttribute('aria-disabled', 'true');
        link.tabIndex = -1;
      }
      return link;
    }

    function renderSleeveSummary(sleeveKey, summary, sourcesText) {
      const summaryWrap = document.getElementById(`summary-${sleeveKey}`);
      summaryWrap.innerHTML = '';
      if (!summary) {
        return;
      }

      const metrics = document.createElement('div');
      metrics.className = 'summary-metrics';
      metrics.appendChild(createBadge('metric-badge', `RAW ${summary.raw_count || 0}`));
      metrics.appendChild(createBadge('metric-badge', `DEDUPED ${summary.deduped_count || 0}`));
      metrics.appendChild(createBadge('metric-badge metric-pass', `PASS ${summary.pass_count || 0}`));
      metrics.appendChild(createBadge('metric-badge metric-maybe', `MAYBE ${summary.maybe_count || 0}`));
      metrics.appendChild(createBadge('metric-badge metric-fail', `FAIL ${summary.fail_count || 0}`));
      summaryWrap.appendChild(metrics);

      const details = document.createElement('p');
      const topReason = Array.isArray(summary.top_fail_reasons) && summary.top_fail_reasons.length
        ? `${summary.top_fail_reasons[0].reason} (${summary.top_fail_reasons[0].count})`
        : 'none';
      details.textContent = `Sources: ${sourcesText || 'none'} | Top fail reason: ${topReason}`;
      summaryWrap.appendChild(details);
    }

    function clearSleevePager(sleeveKey) {
      sleevePagination[sleeveKey] = { jobs: [], page: 1 };
      const pagerDiv = document.getElementById(`pager-${sleeveKey}`);
      if (!pagerDiv) {
        return;
      }
      pagerDiv.innerHTML = '';
      pagerDiv.hidden = true;
    }

    function renderSleevePage(sleeveKey, requestedPage = 1) {
      const resultsDiv = document.getElementById(`results-${sleeveKey}`);
      const pagerDiv = document.getElementById(`pager-${sleeveKey}`);
      const state = sleevePagination[sleeveKey] || { jobs: [], page: 1 };
      const jobs = Array.isArray(state.jobs) ? state.jobs : [];

      resultsDiv.innerHTML = '';
      pagerDiv.innerHTML = '';

      if (!jobs.length) {
        pagerDiv.hidden = true;
        return;
      }

      const total = jobs.length;
      const pageCount = Math.max(1, Math.ceil(total / RESULTS_PER_PAGE));
      const safePage = Math.min(Math.max(1, requestedPage), pageCount);
      const startIndex = (safePage - 1) * RESULTS_PER_PAGE;
      const endIndex = Math.min(startIndex + RESULTS_PER_PAGE, total);

      sleevePagination[sleeveKey] = { jobs, page: safePage };
      jobs.slice(startIndex, endIndex).forEach(job => {
        resultsDiv.appendChild(createJobResult(job));
      });

      const prevBtn = document.createElement('button');
      prevBtn.type = 'button';
      prevBtn.className = 'pager-btn';
      prevBtn.textContent = 'Previous';
      prevBtn.disabled = safePage <= 1;
      prevBtn.addEventListener('click', () => renderSleevePage(sleeveKey, safePage - 1));

      const nextBtn = document.createElement('button');
      nextBtn.type = 'button';
      nextBtn.className = 'pager-btn';
      nextBtn.textContent = 'Next';
      nextBtn.disabled = safePage >= pageCount;
      nextBtn.addEventListener('click', () => renderSleevePage(sleeveKey, safePage + 1));

      const info = document.createElement('span');
      info.className = 'pager-info';
      info.textContent = `Showing ${startIndex + 1}-${endIndex} of ${total} (page ${safePage}/${pageCount})`;

      pagerDiv.appendChild(prevBtn);
      pagerDiv.appendChild(info);
      pagerDiv.appendChild(nextBtn);
      pagerDiv.hidden = false;
    }

    function createJobResult(job) {
      const card = document.createElement('article');
      card.className = 'job-card';

      const sourceLabels = sourceLabelMap();
      const decision = (job.decision || 'PASS').toUpperCase();
      const sleeveId = job.primary_sleeve_id || job.primary_sleeve || '-';
      const mode = resolveWorkMode(job);
      const abroadScore = Number.isFinite(job.abroad_score) ? Number(job.abroad_score) : 0;
      const abroadPctText = String(job.abroad_percentage_text || '').trim();
      const abroadShare = abroadPctText || (Number.isFinite(job.abroad_percentage) ? `${job.abroad_percentage}%` : '');
      const abroadLocations = Array.isArray(job.abroad_locations) ? job.abroad_locations : [];
      const mainLocation = String(job.main_location || job.location || 'Unknown').trim() || 'Unknown';
      const distanceKm = Number.isFinite(job.distance_from_home_km) ? Number(job.distance_from_home_km) : null;
      const distanceAnchor = String(job.distance_anchor || 'Home').trim() || 'Home';
      const proximityScore = Number.isFinite(job.proximity_score) ? Number(job.proximity_score) : null;
      const primaryLink = isValidHttpUrl(job.link || job.url) ? (job.link || job.url) : '';
      const indeedUrl = isValidHttpUrl(job.indeed_url)
        ? job.indeed_url
        : (isValidHttpUrl(primaryLink) ? primaryLink : buildIndeedPostingFallbackUrl(job));
      let companyUrl = isValidHttpUrl(job.company_url) ? job.company_url : '';
      if (isIndeedUrl(companyUrl)) {
        companyUrl = '';
      }
      if (companyUrl && indeedUrl && companyUrl === indeedUrl) {
        companyUrl = '';
      }
      if (!companyUrl) {
        companyUrl = extractExternalFromIndeedUrl(indeedUrl);
      }
      if (companyUrl && isIndeedUrl(companyUrl)) {
        companyUrl = '';
      }

      const header = document.createElement('div');
      header.className = 'job-card-header';
      const title = document.createElement('h3');
      title.textContent = job.title || 'Unknown role';
      const company = document.createElement('p');
      company.className = 'job-company';
      company.textContent = job.company || 'Unknown company';
      header.appendChild(title);
      header.appendChild(company);
      card.appendChild(header);

      const badges = document.createElement('div');
      badges.className = 'job-badges';
      const decisionClass = decision === 'PASS'
        ? 'decision-badge decision-pass'
        : (decision === 'MAYBE' ? 'decision-badge decision-maybe' : 'decision-badge decision-fail');
      badges.appendChild(createBadge(decisionClass, decision));
      badges.appendChild(createBadge('decision-badge decision-neutral', `Career Sleeve ${sleeveId} ${job.primary_sleeve_score || 0}/5`));
      badges.appendChild(
        createBadge(
          'decision-badge decision-abroad',
          abroadShare ? `Abroad ${abroadScore}/4 ${abroadShare}` : `Abroad ${abroadScore}/4`
        )
      );
      const locationBadgeText = distanceKm === null
        ? `Main ${mainLocation} | ${distanceAnchor} distance n/a`
        : `Main ${mainLocation} | ${distanceKm} km from ${distanceAnchor}`;
      badges.appendChild(
        createBadge(
          'decision-badge decision-location',
          proximityScore === null
            ? locationBadgeText
            : `${locationBadgeText} | ${proximityScore}/4`
        )
      );
      card.appendChild(badges);

      const primaryMeta = document.createElement('p');
      primaryMeta.textContent = `Location: ${job.location || 'Unknown'} | Mode: ${mode}`;
      card.appendChild(primaryMeta);

      const secondaryMeta = document.createElement('p');
      secondaryMeta.textContent = `Salary: ${job.salary || 'Not listed'} | Date: ${job.date || job.date_posted || 'Unknown'} | Source: ${sourceLabels[job.source] || job.source || 'Unknown'}`;
      card.appendChild(secondaryMeta);

      if (abroadLocations.length) {
        const abroadGeo = document.createElement('p');
        abroadGeo.className = 'job-abroad-geo';
        abroadGeo.textContent = `Abroad geo mentions: ${abroadLocations.slice(0, 6).join(', ')}`;
        card.appendChild(abroadGeo);
      }

      const reasons = Array.isArray(job.reasons) && job.reasons.length
        ? job.reasons
        : (Array.isArray(job.why_relevant) ? job.why_relevant : []);
      if (reasons.length) {
        const whyList = document.createElement('ul');
        reasons.slice(0, 2).forEach(reason => {
          const li = document.createElement('li');
          li.textContent = reason;
          whyList.appendChild(li);
        });
        card.appendChild(whyList);
      }

      const actions = document.createElement('div');
      actions.className = 'job-actions';
      actions.appendChild(
        createActionLink(
          'Company Posting',
          companyUrl || '#',
          'job-link-company',
          Boolean(companyUrl)
        )
      );
      actions.appendChild(
        createActionLink(
          'Indeed Posting',
          indeedUrl || buildIndeedPostingFallbackUrl(job),
          'job-link-indeed',
          true
        )
      );
      card.appendChild(actions);

      return card;
    }

    async function loadScrapeConfig() {
      try {
        const response = await fetch('/scrape-config');
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}`);
        }
        const payload = await response.json();
        if (payload && Array.isArray(payload.sources) && payload.defaults) {
          scrapeConfig = payload;
        }
      } catch (error) {
        scrapeConfig = fallbackConfig;
      } finally {
        renderControls();
      }
    }

    function renderControls() {
      const defaults = scrapeConfig.defaults || fallbackConfig.defaults;
      const profile = String(scrapeConfig.profile || 'mvp').toLowerCase();
      const locationModes = scrapeConfig.location_modes || [
        { id: 'nl_only', label: 'Netherlands focus' },
        { id: 'nl_eu', label: 'Netherlands + EU remote' },
        { id: 'global', label: 'Global' }
      ];
      const profileHint = document.getElementById('profile-hint');
      profileHint.textContent = profile === 'mvp'
        ? 'Active profile: MVP (Indeed NL only, no auto failover).'
        : `Active profile: ${profile.toUpperCase()}.`;

      const locationSelect = document.getElementById('global-location');
      locationSelect.innerHTML = '';
      locationModes.forEach(mode => {
        const option = document.createElement('option');
        option.value = mode.id;
        option.textContent = mode.label;
        locationSelect.appendChild(option);
      });
      locationSelect.value = defaults.location_mode || 'nl_only';
      document.getElementById('global-strict').checked = defaults.strict !== false;
      document.getElementById('global-cache').checked = defaults.use_cache !== false;
      const failoverInput = document.getElementById('global-failover');
      const failoverWrap = document.getElementById('global-failover-wrap');
      failoverInput.checked = defaults.failover === true;
      failoverInput.disabled = profile === 'mvp';
      failoverWrap.style.opacity = profile === 'mvp' ? '0.55' : '1';

      const sourceWrap = document.getElementById('global-sources');
      const unavailableWrapper = document.getElementById('unavailable-sources');
      const unavailableList = document.getElementById('unavailable-source-list');
      sourceWrap.innerHTML = '';
      unavailableList.innerHTML = '';

      const availableSources = (scrapeConfig.sources || []).filter(source => source.available);
      const unavailableSources = (scrapeConfig.sources || []).filter(source => !source.available);
      availableSources.forEach(source => {
        const checkedByDefault = (defaults.sources || []).includes(source.id) || availableSources.length === 1;
        const label = document.createElement('label');
        label.className = 'source-option source-pill';
        label.innerHTML = `
          <input type="checkbox" data-source-id="${source.id}" ${checkedByDefault ? 'checked' : ''} ${profile === 'mvp' ? 'disabled' : ''}>
          ${source.label}
        `;
        sourceWrap.appendChild(label);
      });

      if (profile !== 'mvp' && unavailableSources.length) {
        unavailableWrapper.hidden = false;
        unavailableSources.forEach(source => {
          const row = document.createElement('div');
          row.className = 'unavailable-row';
          row.textContent = `${source.label} - ${source.reason || 'Unavailable on this server'}`;
          unavailableList.appendChild(row);
        });
      } else {
        unavailableWrapper.hidden = true;
      }

      const sourceNote = document.getElementById('source-note');
      if (!availableSources.length) {
        sourceNote.textContent = 'No sources are currently available. Check API keys on the server.';
      } else if (profile === 'mvp') {
        sourceNote.textContent = `MVP mode: using ${availableSources[0].label} only.`;
      } else {
        sourceNote.textContent = `Recommended: ${availableSources
          .filter(source => (defaults.sources || []).includes(source.id))
          .map(source => source.label)
          .join(', ') || availableSources[0].label}`;
      }
    }

    function selectedSources() {
      const wrap = document.getElementById('global-sources');
      return Array.from(wrap.querySelectorAll('input[type="checkbox"]:checked'))
        .map(input => input.getAttribute('data-source-id'))
        .filter(Boolean);
    }

    function buildScrapeUrl(sleeveKey) {
      const sources = ['indeed_web'];
      const maxResults = Math.max(
        DEFAULT_FETCH_LIMIT,
        Number(scrapeConfig.defaults?.max_results || DEFAULT_FETCH_LIMIT)
      );
      const hasDirectScrape = sources.includes('indeed_web') || sources.includes('linkedin_web');
      const tunedMaxPages = hasDirectScrape ? 3 : 5;
      const tunedTargetRaw = hasDirectScrape
        ? Math.max(40, Math.min(120, maxResults * 3))
        : Math.max(60, Math.min(150, maxResults * 4));
      const extraInput = document.getElementById(`extra-terms-${sleeveKey}`);
      const extraTerms = String(extraInput?.value || '').trim();
      const params = new URLSearchParams();
      params.set('sleeve', sleeveKey);
      params.set('location_mode', 'nl_only');
      params.set('strict', '0');
      params.set('max_results', String(maxResults));
      params.set('max_pages', String(tunedMaxPages));
      params.set('target_raw', String(tunedTargetRaw));
      params.set('no_new_unique_pages', hasDirectScrape ? '1' : '2');
      params.set('refresh', '0');
      params.set('failover', '0');
      params.set('sources', sources.join(','));
      if (extraTerms) {
        params.set('extra_terms', extraTerms);
      }
      return `/scrape?${params.toString()}`;
    }

    function startScraping(sleeveKey) {
      const resultsDiv = document.getElementById(`results-${sleeveKey}`);
      const errorDiv = document.getElementById(`error-${sleeveKey}`);
      const status = document.getElementById(`status-${sleeveKey}`);
      const summaryDiv = document.getElementById(`summary-${sleeveKey}`);
      const panel = document.getElementById(`panel-${sleeveKey}`);

      if (sleeveControllers[sleeveKey]) {
        sleeveControllers[sleeveKey].abort();
      }
      const controller = new AbortController();
      sleeveControllers[sleeveKey] = controller;
      const timeoutId = setTimeout(() => controller.abort(), 120000);

      panel.classList.add('loading');
      resultsDiv.innerHTML = '';
      summaryDiv.innerHTML = '';
      clearSleevePager(sleeveKey);
      errorDiv.style.display = 'none';
      status.textContent = `Scraping Career Sleeve ${sleeveKey} with selected filters...`;

      fetch(buildScrapeUrl(sleeveKey), { signal: controller.signal })
        .then(async response => {
          const contentType = (response.headers.get('content-type') || '').toLowerCase();
          const isJson = contentType.includes('application/json');

          if (!response.ok) {
            if (isJson) {
              const payload = await response.json();
              throw new Error(payload.error || `HTTP ${response.status}`);
            }

            const bodyText = await response.text();
            const compact = bodyText.replace(/\s+/g, ' ').trim().slice(0, 180);
            throw new Error(`HTTP ${response.status}: non-JSON response (${compact || 'empty body'})`);
          }

          if (!isJson) {
            const bodyText = await response.text();
            const compact = bodyText.replace(/\s+/g, ' ').trim().slice(0, 180);
            throw new Error(`Expected JSON but received non-JSON response (${compact || 'empty body'})`);
          }

          const payload = await response.json();
          const jobs = Array.isArray(payload)
            ? payload
            : (Array.isArray(payload.jobs) ? payload.jobs : []);
          const summary = (!Array.isArray(payload) && payload.summary && typeof payload.summary === 'object')
            ? payload.summary
            : null;
          const sourcesFromSummary = summary && Array.isArray(summary.sources_used_labels)
            ? summary.sources_used_labels.join(', ')
            : (summary && Array.isArray(summary.sources_used)
              ? summary.sources_used.join(', ')
              : '');
          const profileFromSummary = summary && typeof summary.profile === 'string'
            ? summary.profile
            : '';
          return {
            jobs,
            summary,
            profile: profileFromSummary || (scrapeConfig.profile || 'mvp'),
            sourcesUsed: sourcesFromSummary || response.headers.get('x-sources-used') || 'none'
          };
        })
        .then(payload => {
          const data = payload.jobs;
          if (payload.summary) {
            status.textContent = `Finished Career Sleeve ${sleeveKey} (${String(payload.profile || '').toUpperCase()}).`;
            renderSleeveSummary(sleeveKey, payload.summary, payload.sourcesUsed);
          } else {
            status.textContent = `Finished Career Sleeve ${sleeveKey}. Found ${data.length} relevant jobs. Sources: ${payload.sourcesUsed}.`;
          }
          if (!data.length) {
            clearSleevePager(sleeveKey);
            if (payload.summary && Array.isArray(payload.summary.top_fail_reasons) && payload.summary.top_fail_reasons.length) {
              const firstReason = payload.summary.top_fail_reasons[0];
              resultsDiv.textContent = `No jobs matched this Career Sleeve with the current filters. Top fail reason: ${firstReason.reason} (${firstReason.count}).`;
            } else {
              resultsDiv.textContent = 'No jobs matched this Career Sleeve with the current filters. Try broadening terms.';
            }
            return;
          }

          sleevePagination[sleeveKey] = { jobs: data, page: 1 };
          renderSleevePage(sleeveKey, 1);
        })
        .catch(error => {
          status.textContent = '';
          const isTimeout = error.name === 'AbortError';
          errorDiv.textContent = isTimeout
            ? `Scrape for Career Sleeve ${sleeveKey} timed out after 120 seconds.`
            : `An error occurred while scraping jobs: ${error.message}`;
          errorDiv.style.display = 'block';
        })
        .finally(() => {
          clearTimeout(timeoutId);
          panel.classList.remove('loading');
          if (sleeveControllers[sleeveKey] === controller) {
            delete sleeveControllers[sleeveKey];
          }
        });
    }

    document.addEventListener('DOMContentLoaded', loadScrapeConfig);
  </script>

  <script src="{{ url_for('static', filename='script.js') }}"></script>
</body>

</html>
