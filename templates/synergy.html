<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>2025-2035</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
  <style>
    .synergy-shell { max-width: 920px; margin: 18px auto 32px; }
    .synergy-column {
      --synergy-zircon-deep: #006f75;
      --synergy-heliodor-deep: #8f6800;
      --synergy-rubellite-deep: #8f2344;
      --synergy-amethyst-deep: #452d8f;
      --synergy-inner-radius: 10px;
      border: none; border-radius: 22px; padding: 16px; display: grid; gap: 12px;
      background: linear-gradient(145deg, rgba(var(--white-rgb), 0.78), rgba(var(--white-rgb), 0.58));
      box-shadow: var(--shadow-soft); backdrop-filter: var(--glass-blur); -webkit-backdrop-filter: var(--glass-blur);
    }
    .synergy-sleeve-header {
      margin: 0; padding: 8px 10px; border-radius: var(--synergy-inner-radius); color: var(--white);
      text-shadow: 0 1px 2px rgba(var(--black-rgb), 0.18);
      background: linear-gradient(100deg, rgba(var(--amethyst-rgb), 0.84), rgba(var(--zircon-rgb), 0.68));
    }
    .synergy-sleeve-header-clickable {
      cursor: pointer;
    }
    .synergy-sleeve-header-clickable:hover {
      filter: brightness(1.02);
    }
    .synergy-sleeve-header-clickable:focus-visible {
      outline: 2px solid rgba(var(--white-rgb), 0.92);
      outline-offset: 2px;
    }
    .synergy-row { display: grid; gap: 6px; }
    .synergy-row label { font-weight: 600; color: var(--ink-muted); font-size: 0.85rem; }
    .synergy-inline { display: flex; flex-wrap: wrap; gap: 8px; align-items: center; }
    .synergy-editor-grid { display: grid; grid-template-columns: 180px 1fr; gap: 8px; }
    .synergy-row select, .synergy-row input, .synergy-inline input {
      border: none; border-radius: var(--synergy-inner-radius); padding: 8px 10px; color: var(--ink);
      background: linear-gradient(140deg, rgba(var(--white-rgb), 0.92), rgba(var(--white-rgb), 0.66));
    }
    .synergy-term-box {
      border: none; border-radius: var(--synergy-inner-radius); padding: 10px; display: grid; gap: 8px;
      background: linear-gradient(140deg, rgba(var(--amethyst-rgb), 0.06), rgba(var(--white-rgb), 0.45));
    }
    .synergy-term-chip {
      display: inline-flex; align-items: center; gap: 6px; border-radius: 999px;
      padding: 4px; background: rgba(var(--amethyst-rgb), 0.14); color: var(--synergy-amethyst-deep);
      font-size: 0.8rem; font-weight: 600; white-space: nowrap;
    }
    .synergy-term-chip-label { margin-right: 2px; padding-left: 5px; }
    .synergy-term-chip button {
      border: none; border-radius: 999px; width: 18px; height: 18px; min-width: 18px;
      padding: 0; margin: 0; font-size: 0.8rem; line-height: 1;
      background: rgba(var(--amethyst-rgb), 0.2); color: var(--synergy-amethyst-deep); opacity: 1;
      transform: none; transition: background 0.14s ease;
      margin-left: auto;
      margin-right: -1px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }
    .synergy-term-chip button:hover { transform: none; filter: none; background: rgba(var(--amethyst-rgb), 0.26); }
    .synergy-progress, .synergy-results {
      border: none; border-radius: var(--synergy-inner-radius); padding: 12px; display: grid; gap: 10px;
      background: linear-gradient(140deg, rgba(var(--white-rgb), 0.76), rgba(var(--white-rgb), 0.52));
    }
    .synergy-progress h3, .synergy-results h3 { margin: 0; font-size: 1rem; }
    .synergy-metrics { display: flex; flex-wrap: wrap; gap: 6px; }
    .synergy-metric { border-radius: 999px; padding: 4px 9px; font-size: 0.74rem; font-weight: 800; background: rgba(var(--black-rgb), 0.06); }
    .synergy-metric-pass { background: rgba(var(--zircon-rgb), 0.2); color: var(--synergy-zircon-deep); }
    .synergy-metric-maybe { background: rgba(var(--heliodor-rgb), 0.26); color: var(--synergy-heliodor-deep); }
    .synergy-metric-fail { background: rgba(var(--rubellite-rgb), 0.18); color: var(--synergy-rubellite-deep); }
    .synergy-event-list { margin: 0; padding-left: 18px; display: grid; gap: 4px; font-size: 0.84rem; }
    .synergy-empty { color: var(--ink-muted); font-size: 0.86rem; font-weight: 600; }
    .synergy-result-list { display: grid; gap: 10px; max-height: 760px; overflow-y: auto; padding-right: 4px; }
    .synergy-job-card { border: none; border-radius: var(--synergy-inner-radius); padding: 10px; display: grid; gap: 7px; background: linear-gradient(145deg, rgba(var(--white-rgb), 0.84), rgba(var(--white-rgb), 0.62)); }
    .synergy-job-title { margin: 0; font-size: 0.98rem; color: var(--ink); }
    .synergy-job-meta { margin: 0; color: var(--ink-muted); font-size: 0.84rem; font-weight: 600; }
    .synergy-job-links { display: flex; flex-wrap: wrap; gap: 6px; }
    .synergy-link-btn {
      border: none; border-radius: 999px; padding: 6px 10px; font-size: 0.78rem; font-weight: 800; color: var(--white);
      background: linear-gradient(125deg, rgba(var(--amethyst-rgb), 0.9), rgba(var(--amethyst-rgb), 0.72));
      opacity: 0.9; display: inline-flex; align-items: center; justify-content: center;
    }
    .synergy-link-btn:hover { filter: brightness(0.98); transform: translateY(-1px); opacity: 1; }
    .synergy-column-actions {
      display: flex;
      gap: 8px;
      align-items: center;
      justify-content: flex-start;
    }
    .synergy-dialog {
      border: none; border-radius: 14px; padding: 14px; width: min(680px, calc(100vw - 28px));
      background: linear-gradient(145deg, rgba(var(--white-rgb), 0.94), rgba(var(--white-rgb), 0.82));
      box-shadow: 0 20px 44px rgba(var(--black-rgb), 0.24);
    }
    .synergy-dialog::backdrop { background: rgba(var(--black-rgb), 0.3); backdrop-filter: blur(4px); -webkit-backdrop-filter: blur(4px); }
    .synergy-dialog-header { display: flex; align-items: center; justify-content: space-between; gap: 10px; margin-bottom: 10px; }
    .synergy-dialog-header h3 { margin: 0; font-size: 1.05rem; }
    .synergy-dialog-list { display: grid; gap: 10px; max-height: 56vh; overflow-y: auto; padding-right: 2px; }
    .synergy-dialog-search {
      width: 100%;
      border: none;
      border-radius: 10px;
      padding: 8px 10px;
      margin-bottom: 8px;
      background: linear-gradient(140deg, rgba(var(--white-rgb), 0.94), rgba(var(--white-rgb), 0.74));
      color: var(--ink);
    }
    .synergy-dialog-search:focus,
    #dialogTermInput:focus {
      outline: none;
      box-shadow: inset 0 0 0 2px rgba(var(--amethyst-rgb), 0.22);
    }
    .synergy-dialog-group { display: grid; gap: 6px; }
    .synergy-dialog-group-title { font-size: 0.82rem; color: var(--ink-muted); font-weight: 700; text-transform: uppercase; letter-spacing: 0.04em; }
    .synergy-dialog-option { width: 100%; text-align: left; }
    .synergy-dialog-option-row {
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .synergy-dialog-option-row-active {
      align-items: stretch;
    }
    .synergy-dialog-sleeve-block {
      display: grid;
      gap: 8px;
    }
    .synergy-dialog-option-main {
      flex: 1 1 auto;
    }
    .synergy-dialog-option-split {
      display: flex;
      align-items: stretch;
      gap: 0;
      padding: 0;
      overflow: hidden;
      border-radius: 10px;
      min-height: 36px;
    }
    .synergy-dialog-option-split-letter {
      width: 36px;
      min-width: 36px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-size: 0.86rem;
      font-weight: 800;
      color: rgba(var(--white-rgb), 0.98);
      background: rgba(var(--black-rgb), 0.14);
      user-select: none;
    }
    .synergy-dialog-option-split-title {
      flex: 1 1 auto;
      display: inline-flex;
      align-items: center;
      padding: 0 10px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      font-weight: 700;
    }
    .synergy-dialog-inline-title-wrap {
      flex: 1 1 auto;
      min-height: 36px;
      display: flex;
      align-items: stretch;
      border: none;
      border-radius: 10px;
      overflow: hidden;
      background: linear-gradient(125deg, rgba(var(--amethyst-rgb), 0.9), rgba(var(--amethyst-rgb), 0.72));
      cursor: text;
      transition: filter 0.14s ease, box-shadow 0.14s ease;
    }
    .synergy-dialog-inline-title-wrap:hover {
      filter: brightness(1.02);
    }
    .synergy-dialog-inline-title-wrap:focus-within {
      box-shadow: inset 0 0 0 2px rgba(var(--white-rgb), 0.34);
    }
    .synergy-dialog-inline-title-letter {
      width: 36px;
      min-width: 36px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-size: 0.86rem;
      font-weight: 800;
      color: rgba(var(--white-rgb), 0.98);
      background: rgba(var(--black-rgb), 0.12);
      border-right: 1px solid rgba(var(--white-rgb), 0.28);
      user-select: none;
    }
    .synergy-dialog-inline-title-input {
      flex: 1 1 auto;
      border: none;
      border-radius: 0;
      padding: 0 10px;
      color: rgba(var(--white-rgb), 0.88);
      font-weight: 700;
      font-size: 0.88rem;
      background: transparent;
    }
    .synergy-dialog-inline-title-input::placeholder {
      color: rgba(var(--white-rgb), 0.62);
    }
    .synergy-dialog-inline-title-input:focus {
      outline: none;
      box-shadow: none;
    }
    .synergy-dialog-row-actions {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      flex: 0 0 auto;
    }
    .synergy-dialog-row-save {
      border: none;
      border-radius: 999px;
      width: 62px;
      min-width: 62px;
      padding: 6px 0;
      font-size: 0.74rem;
      font-weight: 800;
      color: var(--white);
      background: linear-gradient(125deg, rgba(var(--amethyst-rgb), 0.9), rgba(var(--amethyst-rgb), 0.72));
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      text-align: center;
    }
    .synergy-dialog-inline-editor {
      overflow: hidden;
      max-height: 0;
      opacity: 0;
      transform: translateY(-4px);
      transition: max-height 0.22s ease, opacity 0.18s ease, transform 0.18s ease;
      pointer-events: none;
    }
    .synergy-dialog-inline-editor.is-open {
      max-height: 560px;
      opacity: 1;
      transform: translateY(0);
      pointer-events: auto;
    }
    .synergy-dialog-option-icon {
      border: none;
      border-radius: 999px;
      width: 28px;
      height: 28px;
      min-width: 28px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-size: 0.95rem;
      font-weight: 800;
      color: var(--synergy-amethyst-deep);
      background: rgba(var(--amethyst-rgb), 0.16);
      cursor: pointer;
      transition: background 0.14s ease;
    }
    .synergy-dialog-option-icon:hover {
      background: rgba(var(--amethyst-rgb), 0.24);
      transform: none;
    }
    .synergy-dialog-custom-create {
      display: grid;
      gap: 8px;
      margin-top: 0;
      padding: 0;
      border-radius: var(--synergy-inner-radius);
      background: transparent;
    }
    .synergy-dialog-custom-create.is-hidden {
      display: none;
    }
    .synergy-dialog-custom-note {
      color: var(--synergy-heliodor-deep);
      font-size: 0.8rem;
      font-weight: 600;
      border-radius: 8px;
      padding: 6px 8px;
      background: rgba(var(--heliodor-rgb), 0.22);
    }
    .synergy-dialog-custom-note.is-info {
      color: var(--synergy-heliodor-deep);
      background: rgba(var(--heliodor-rgb), 0.22);
    }
    .synergy-dialog-custom-note.is-success {
      color: var(--synergy-zircon-deep);
      background: rgba(var(--zircon-rgb), 0.22);
    }
    .synergy-dialog-custom-note.is-error {
      color: var(--synergy-rubellite-deep);
      background: rgba(var(--rubellite-rgb), 0.18);
    }
    .synergy-term-chip-list {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      align-items: center;
    }
    .synergy-dialog-editor-actions {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
    }
    .synergy-dialog-editor-actions button {
      flex: 1 1 180px;
    }
    .synergy-dialog-add-trigger {
      width: 36px;
      height: 36px;
      min-width: 36px;
      border: none;
      border-radius: 10px;
      padding: 0;
      color: rgba(var(--white-rgb), 0.98);
      background: linear-gradient(125deg, rgba(var(--amethyst-rgb), 0.9), rgba(var(--amethyst-rgb), 0.72));
      box-shadow: inset 0 0 0 999px rgba(var(--black-rgb), 0.14);
      font-family: "Manrope", sans-serif;
      font-weight: 800;
      font-size: 1.05rem;
      line-height: 1;
      text-align: center;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      align-self: flex-start;
      cursor: pointer;
      opacity: 1;
    }
    .synergy-dialog-add-trigger:hover {
      filter: brightness(1.03);
      transform: none;
    }
    @media (max-width: 720px) { .synergy-editor-grid { grid-template-columns: 1fr; } .synergy-shell { margin-top: 12px; } }
  </style>
</head>
<body>
  <a href="{{ url_for('index') }}"><h1>Timeline</h1></a>
  <nav class="timeline" aria-label="synergy timeline">
    <div class="sub-decade-container"><span class="sub-decade">2025</span></div>
    <div class="main-decade-container highlight"><span class="main-decade">SYNERGY</span></div>
    <div class="sub-decade-container"><span class="sub-decade">2035</span></div>
  </nav>

  <main class="synergy-shell">
    <section class="synergy-column">
      <header
        id="headerEditorTrigger"
        class="synergy-sleeve-header synergy-sleeve-header-clickable"
        role="button"
        tabindex="0"
        aria-label="Set sleeve letter and title"
      >
        <span id="headerName" class="sleeve-header-name">Click here to start</span>
        <span id="headerCode" class="sleeve-header-code">Career Sleeve ?</span>
      </header>

      <div class="synergy-column-actions">
        <button id="scrapeNowBtn" type="button">Scrape job postings</button>
      </div>

      <section class="synergy-progress">
        <h3>Scrape Progress</h3>
        <div id="metricBadges" class="synergy-metrics"></div>
        <ul id="progressEvents" class="synergy-event-list"></ul>
      </section>

      <section class="synergy-results">
        <h3>Results</h3>
        <div id="resultList" class="synergy-result-list"></div>
      </section>
    </section>
  </main>

  <dialog id="loadDialog" class="synergy-dialog">
    <div class="synergy-dialog-header">
      <h3>Set sleeve letter and title</h3>
      <button id="closeLoadDialogBtn" type="button">Close</button>
    </div>
    <input id="loadDialogSearch" class="synergy-dialog-search" type="text" autocomplete="off" placeholder="Search by letter or title...">
    <div id="loadDialogList" class="synergy-dialog-list"></div>
    <section id="dialogEditorSection" class="synergy-dialog-inline-editor synergy-dialog-custom-create is-hidden">
      <div class="synergy-term-box">
        <div id="dialogCustomNote" class="synergy-dialog-custom-note is-info">Click + to add a custom sleeve.</div>
        <div id="dialogTermChipList" class="synergy-term-chip-list"></div>
        <div class="synergy-inline">
          <input id="dialogTermInput" type="text" autocomplete="off" placeholder="Type term and press Enter">
        </div>
        <div class="synergy-dialog-editor-actions">
          <button id="dialogAddTermBtn" type="button">Add term</button>
          <button id="dialogGenerateTermsBtn" type="button">Generate terms</button>
          <button id="dialogClearTermsBtn" type="button">Clear terms</button>
        </div>
      </div>
    </section>
  </dialog>

  <script>
    (() => {
      const state = {
        catalog: { fixed: [], custom: [], all: [] },
        current: { letter: "", title: "", terms: [] },
        editor: { mode: "add", letter: "", title: "", terms: [], anchor: "" },
        editorVisible: false,
        progressTimer: null,
        loadFilter: "",
        localProgressEvents: [],
        remoteProgressEvents: [],
      };
      const els = {
        scrapeNowBtn: document.getElementById("scrapeNowBtn"),
        metricBadges: document.getElementById("metricBadges"),
        progressEvents: document.getElementById("progressEvents"),
        resultList: document.getElementById("resultList"),
        headerName: document.getElementById("headerName"),
        headerCode: document.getElementById("headerCode"),
        headerEditorTrigger: document.getElementById("headerEditorTrigger"),
        loadDialog: document.getElementById("loadDialog"),
        loadDialogList: document.getElementById("loadDialogList"),
        loadDialogSearch: document.getElementById("loadDialogSearch"),
        dialogEditorSection: document.getElementById("dialogEditorSection"),
        closeLoadDialogBtn: document.getElementById("closeLoadDialogBtn"),
        dialogTermChipList: document.getElementById("dialogTermChipList"),
        dialogTermInput: document.getElementById("dialogTermInput"),
        dialogAddTermBtn: document.getElementById("dialogAddTermBtn"),
        dialogGenerateTermsBtn: document.getElementById("dialogGenerateTermsBtn"),
        dialogClearTermsBtn: document.getElementById("dialogClearTermsBtn"),
        dialogCustomNote: document.getElementById("dialogCustomNote"),
      };

      const normalizeLetter = (v) => (/^[A-Z]$/.test(String(v || "").trim().toUpperCase()) ? String(v || "").trim().toUpperCase() : "");
      const isFixedLetter = (l) => ["A", "B", "C", "D"].includes(l);
      const isCustomLetter = (l) => /^[A-Z]$/.test(l || "") && l >= "E";
      const dedupeTerms = (arr) => {
        const seen = new Set();
        const out = [];
        (arr || []).forEach((raw) => {
          const t = String(raw || "").trim();
          if (t.length < 2) return;
          const k = t.toLowerCase();
          if (seen.has(k)) return;
          seen.add(k);
          out.push(t);
        });
        return out;
      };
      const findCustom = (l) => (state.catalog.custom || []).find((x) => x.letter === l) || null;
      const ICON_EDIT = "\u270E";
      const ICON_REMOVE = "\u00D7";
      const getNextCustomLetter = () => {
        const usedCustomLetters = new Set(
          (state.catalog.custom || [])
            .map((entry) => normalizeLetter(entry && entry.letter))
            .filter(Boolean)
        );
        for (let code = 69; code <= 90; code += 1) {
          const letter = String.fromCharCode(code);
          if (!usedCustomLetters.has(letter)) return letter;
        }
        return "?";
      };
      const getSaveButtonLabel = () => {
        return "Save";
      };
      const collectCurrent = () => ({
        letter: normalizeLetter(state.current.letter),
        title: String(state.current.title || "").trim(),
        terms: dedupeTerms(state.current.terms),
      });
      const collectEditor = () => ({
        mode: state.editor.mode === "edit" ? "edit" : "add",
        letter: normalizeLetter(state.editor.letter),
        title: String(state.editor.title || "").trim(),
        terms: dedupeTerms(state.editor.terms),
      });

      function setStatus(msg, type = "info", scope = "ui") {
        const text = String(msg || "").trim();
        if (!text) return;
        if (scope !== "scrape") return;
        state.localProgressEvents.push({
          message: text,
          type,
          ts: new Date().toISOString(),
        });
        renderEvents();
      }

      function setDialogNote(msg, type = "info") {
        if (!els.dialogCustomNote) return;
        els.dialogCustomNote.textContent = String(msg || "").trim();
        els.dialogCustomNote.classList.remove("is-info", "is-success", "is-error");
        if (type === "success") {
          els.dialogCustomNote.classList.add("is-success");
          return;
        }
        if (type === "error") {
          els.dialogCustomNote.classList.add("is-error");
          return;
        }
        els.dialogCustomNote.classList.add("is-info");
      }

      function createInlineTitleEditor(letterValue, initialTitle, onInput, onSubmit) {
        const wrap = document.createElement("div");
        wrap.className = "synergy-dialog-inline-title-wrap";

        const letter = document.createElement("span");
        letter.className = "synergy-dialog-inline-title-letter";
        letter.textContent = normalizeLetter(letterValue) || "?";

        const input = document.createElement("input");
        input.type = "text";
        input.maxLength = 120;
        input.className = "synergy-dialog-inline-title-input";
        input.value = String(initialTitle || "");
        input.placeholder = "Type Career Sleeve title...";
        input.addEventListener("input", () => {
          onInput(String(input.value || "").slice(0, 120));
        });
        input.addEventListener("keydown", (event) => {
          if (event.key === "Enter") {
            event.preventDefault();
            onSubmit();
          }
        });

        const focusInput = () => input.focus();
        wrap.addEventListener("click", focusInput);
        letter.addEventListener("click", (event) => {
          event.preventDefault();
          focusInput();
        });

        wrap.appendChild(letter);
        wrap.appendChild(input);
        return { wrap, input };
      }

      function createSplitSleeveButton(letterValue, titleValue, onClick) {
        const btn = document.createElement("button");
        btn.type = "button";
        btn.className = "synergy-dialog-option synergy-dialog-option-main synergy-dialog-option-split";

        const letter = document.createElement("span");
        letter.className = "synergy-dialog-option-split-letter";
        letter.textContent = normalizeLetter(letterValue) || "?";

        const title = document.createElement("span");
        title.className = "synergy-dialog-option-split-title";
        title.textContent = String(titleValue || "").trim() || "Untitled sleeve";

        btn.appendChild(letter);
        btn.appendChild(title);
        btn.addEventListener("click", onClick);
        return btn;
      }

      function renderDialogTerms() {
        els.dialogTermChipList.innerHTML = "";
        const editor = collectEditor();
        if (!editor.terms.length) {
          const empty = document.createElement("div");
          empty.className = "synergy-empty";
          empty.textContent = "No terms configured.";
          els.dialogTermChipList.appendChild(empty);
          return;
        }
        editor.terms.forEach((term) => {
          const chip = document.createElement("span");
          chip.className = "synergy-term-chip";
          const label = document.createElement("span");
          label.className = "synergy-term-chip-label";
          label.textContent = term;
          chip.appendChild(label);
          const remove = document.createElement("button");
          remove.type = "button";
          remove.textContent = ICON_REMOVE;
          remove.setAttribute("aria-label", `Remove ${term}`);
          remove.addEventListener("click", () => {
            state.editor.terms = state.editor.terms.filter((t) => t.toLowerCase() !== term.toLowerCase());
            renderDialogTerms();
            setDialogNote(`Removed term "${term}".`, "info");
          });
          chip.appendChild(remove);
          els.dialogTermChipList.appendChild(chip);
        });
      }

      function openHeaderEditor() {
        state.loadFilter = "";
        if (els.loadDialogSearch) {
          els.loadDialogSearch.value = "";
        }
        resetDialogEditor("add", null, false);
        renderLoadDialogList();
        if (typeof els.loadDialog.showModal === "function") {
          els.loadDialog.showModal();
        } else {
          els.loadDialog.setAttribute("open", "open");
        }
        if (els.loadDialogSearch) {
          setTimeout(() => els.loadDialogSearch.focus(), 30);
        }
      }

      function closeHeaderEditor() {
        setDialogEditorVisible(false);
        if (typeof els.loadDialog.close === "function") {
          els.loadDialog.close();
        } else {
          els.loadDialog.removeAttribute("open");
        }
      }

      function setDialogEditorVisible(visible) {
        state.editorVisible = Boolean(visible);
        if (!els.dialogEditorSection) return;
        els.dialogEditorSection.classList.toggle("is-hidden", !state.editorVisible);
        els.dialogEditorSection.classList.toggle("is-open", state.editorVisible);
        if (!state.editorVisible) {
          setDialogNote("Click + to add a custom sleeve.", "info");
        }
      }

      function updateHeaderPreview() {
        const letter = normalizeLetter(state.current.letter);
        const inputTitle = String(state.current.title || "").trim();
        const title = inputTitle || "Click here to start";
        els.headerName.textContent = title;
        els.headerCode.textContent = letter ? `Career Sleeve ${letter}` : "Career Sleeve ?";
      }

      function applySleeveToEditor(sleeve, options = {}) {
        if (!sleeve) return;
        state.current.letter = normalizeLetter(sleeve.letter || "");
        state.current.title = String(sleeve.title || "");
        state.current.terms = dedupeTerms(sleeve.terms || []);
        updateHeaderPreview();
        if (!options.silent) {
          const suffix = sleeve.locked ? "(fixed)" : "(custom)";
          setStatus(`Loaded sleeve ${sleeve.letter} ${suffix}.`, "success");
          setDialogNote(`Loaded Career Sleeve ${sleeve.letter} ${suffix}.`, "success");
        }
      }

      function guessTermsFromTitle(title, letter) {
        const fixedByLetter = (state.catalog.fixed || []).find((entry) => entry.letter === letter);
        if (fixedByLetter && Array.isArray(fixedByLetter.terms) && fixedByLetter.terms.length) {
          return fixedByLetter.terms.slice(0, 8);
        }

        const lowerTitle = String(title || "").toLowerCase();
        const presets = [
          {
            keywords: ["music", "festival", "concert", "tour", "venue", "artist", "event"],
            terms: [
              "music event operations",
              "festival producer",
              "tour operations",
              "concert production",
              "live production",
              "artist liaison",
              "show operations",
              "event operations",
            ],
          },
          {
            keywords: ["theme", "park", "attraction", "guest", "destination", "resort"],
            terms: [
              "theme park operations",
              "attractions operations",
              "guest experience",
              "show operations",
              "ride operations",
              "destination operations",
              "resort operations",
              "immersive destination operations",
            ],
          },
          {
            keywords: ["data", "center", "facility", "critical", "infrastructure", "commissioning"],
            terms: [
              "data center operations",
              "critical facilities technician",
              "facility operations",
              "commissioning engineer data center",
              "mission critical operations",
              "compute infrastructure operations",
              "ai infrastructure operations",
              "capacity expansion data center",
            ],
          },
          {
            keywords: ["supply", "chain", "logistics", "vendor", "distribution", "ecosystem", "partner"],
            terms: [
              "supply chain operations",
              "logistics operations",
              "vendor operations",
              "partner operations",
              "ecosystem operations",
              "rollout",
              "implementation supply chain",
              "distribution operations",
            ],
          },
        ];

        let bestPreset = null;
        let bestScore = 0;
        for (const preset of presets) {
          const score = preset.keywords.reduce((acc, keyword) => acc + (lowerTitle.includes(keyword) ? 1 : 0), 0);
          if (score > bestScore) {
            bestScore = score;
            bestPreset = preset;
          }
        }
        if (bestPreset && bestScore > 0) {
          return bestPreset.terms.slice(0, 8);
        }

        const stopwords = new Set([
          "and", "the", "for", "with", "from", "into", "across", "career", "sleeve", "operations",
        ]);
        const tokens = Array.from(
          new Set(
            lowerTitle
              .split(/[^a-z0-9]+/g)
              .map((token) => token.trim())
              .filter((token) => token.length >= 3 && !stopwords.has(token))
          )
        );

        const fallback = [];
        if (lowerTitle.trim()) {
          fallback.push(lowerTitle.trim());
        }
        for (const token of tokens.slice(0, 3)) {
          fallback.push(`${token} operations`);
          fallback.push(`${token} coordinator`);
          fallback.push(`${token} specialist`);
        }
        fallback.push("cross-functional operations");
        fallback.push("delivery operations");
        fallback.push("workflow operations");
        return dedupeTerms(fallback).slice(0, 8);
      }

      function generateTermsFromEditorTitle() {
        const editor = collectEditor();
        if (!editor.title) {
          setStatus("Set a sleeve title first, then generate terms.", "error");
          setDialogNote("Set a sleeve title first, then generate terms.", "error");
          return;
        }
        const generated = guessTermsFromTitle(editor.title, editor.letter);
        if (!generated.length) {
          setStatus("Could not generate terms from this title.", "error");
          setDialogNote("Could not generate terms from this title.", "error");
          return;
        }
        state.editor.terms = dedupeTerms([...(state.editor.terms || []), ...generated]);
        renderDialogTerms();
        setStatus(`Generated ${generated.length} terms locally (free, no paid API).`, "success");
        setDialogNote(`Generated ${generated.length} terms. Review and save when ready.`, "success");
      }

      function renderMetrics(summary) {
        els.metricBadges.innerHTML = "";
        if (!summary) return;
        const items = [
          ["RAW", summary.raw_count ?? 0, ""],
          ["DEDUPED", summary.deduped_count ?? 0, ""],
          ["PASS", summary.pass_count ?? 0, "synergy-metric-pass"],
          ["MAYBE", summary.maybe_count ?? 0, "synergy-metric-maybe"],
          ["FAIL", summary.fail_count ?? 0, "synergy-metric-fail"],
        ];
        items.forEach(([label, value, cls]) => {
          const b = document.createElement("span");
          b.className = `synergy-metric ${cls}`.trim();
          b.textContent = `${label} ${value}`;
          els.metricBadges.appendChild(b);
        });
      }

      function renderEvents(events) {
        if (Array.isArray(events)) {
          state.remoteProgressEvents = events.slice();
        }
        els.progressEvents.innerHTML = "";
        const combined = [
          ...(state.localProgressEvents || []),
          ...(state.remoteProgressEvents || []),
        ];
        const list = combined
          .slice()
          .sort((a, b) => {
            const ta = Date.parse(String((a && a.ts) || "")) || 0;
            const tb = Date.parse(String((b && b.ts) || "")) || 0;
            return ta - tb;
          })
          .slice(-120);
        if (!list.length) {
          const li = document.createElement("li");
          li.className = "synergy-empty";
          li.textContent = "Waiting for Career Sleeve selection.";
          els.progressEvents.appendChild(li);
          return;
        }
        list.forEach((event) => {
          const li = document.createElement("li");
          li.textContent = event && event.message ? event.message : "Update";
          els.progressEvents.appendChild(li);
        });
      }

      function buildCompanyPostingUrl(job) {
        const p = new URLSearchParams();
        if (job.company_url) p.set("company_url", job.company_url);
        if (job.indeed_url) p.set("indeed_url", job.indeed_url);
        if (job.linkedin_url) p.set("linkedin_url", job.linkedin_url);
        if (job.url) p.set("job_url", job.url);
        const q = p.toString();
        return q ? `/company-posting?${q}` : "";
      }

      function formatDistanceFromHome(value) {
        const numeric = Number(value);
        if (!Number.isFinite(numeric)) return "";
        const rounded = numeric >= 100 ? Math.round(numeric) : Math.round(numeric * 10) / 10;
        const display = Number.isInteger(rounded) ? String(rounded) : rounded.toFixed(1);
        return `${display}km from home`;
      }

      function renderResults(jobs) {
        els.resultList.innerHTML = "";
        if (!Array.isArray(jobs) || !jobs.length) {
          const empty = document.createElement("div");
          empty.className = "synergy-empty";
          empty.textContent = "No jobs returned.";
          els.resultList.appendChild(empty);
          return;
        }
        jobs.forEach((job) => {
          const card = document.createElement("article");
          card.className = "synergy-job-card";
          const title = document.createElement("h4");
          title.className = "synergy-job-title";
          title.textContent = job.title || "Unknown role";
          card.appendChild(title);
          const distanceLabel = formatDistanceFromHome(job.distance_from_home_km);
          const company = document.createElement("p");
          company.className = "synergy-job-meta";
          company.textContent = [
            job.company || "Unknown company",
            job.location || job.main_location || "Unknown location",
            distanceLabel,
          ].filter(Boolean).join(" · ");
          card.appendChild(company);
          const status = document.createElement("p");
          status.className = "synergy-job-meta";
          status.textContent = `${job.decision || "UNKNOWN"} · Sleeve ${job.primary_sleeve_id || "?"} ${job.primary_sleeve_score || 0}/5`;
          card.appendChild(status);
          const links = document.createElement("div");
          links.className = "synergy-job-links";
          const companyUrl = buildCompanyPostingUrl(job);
          if (companyUrl) {
            const a = document.createElement("a");
            a.className = "synergy-link-btn";
            a.href = companyUrl;
            a.target = "_blank";
            a.rel = "noopener noreferrer";
            a.textContent = "Company URL";
            links.appendChild(a);
          }
          if (job.indeed_url) {
            const a = document.createElement("a");
            a.className = "synergy-link-btn";
            a.href = job.indeed_url;
            a.target = "_blank";
            a.rel = "noopener noreferrer";
            a.textContent = "Indeed URL";
            links.appendChild(a);
          }
          if (job.linkedin_url) {
            const a = document.createElement("a");
            a.className = "synergy-link-btn";
            a.href = job.linkedin_url;
            a.target = "_blank";
            a.rel = "noopener noreferrer";
            a.textContent = "LinkedIn URL";
            links.appendChild(a);
          }
          if (!links.childNodes.length) {
            const empty = document.createElement("span");
            empty.className = "synergy-empty";
            empty.textContent = "No outbound URLs available.";
            links.appendChild(empty);
          }
          card.appendChild(links);
          els.resultList.appendChild(card);
        });
      }

      function renderLoadDialogList() {
        els.loadDialogList.innerHTML = "";
        const query = String(state.loadFilter || "").trim().toLowerCase();
        const activeEditorKey = state.editorVisible
          ? (state.editor.mode === "edit" ? `edit:${normalizeLetter(state.editor.letter)}` : "add")
          : "";
        const groups = [
          { title: "FIXED CAREER SLEEVES (A-D)", items: state.catalog.fixed || [], scope: "fixed" },
          { title: "CUSTOM CAREER SLEEVES (E-Z)", items: state.catalog.custom || [], scope: "custom" },
        ];
        groups.forEach((group) => {
          const wrap = document.createElement("div");
          wrap.className = "synergy-dialog-group";
          const title = document.createElement("div");
          title.className = "synergy-dialog-group-title";
          title.textContent = group.title;
          wrap.appendChild(title);
          const filteredItems = (group.items || []).filter((sleeve) => {
            if (!query) return true;
            const hay = `${sleeve.letter || ""} ${sleeve.title || ""}`.toLowerCase();
            return hay.includes(query);
          });
          if (!filteredItems.length) {
            const empty = document.createElement("div");
            empty.className = "synergy-empty";
            empty.textContent = query ? "No matches in this group." : "No sleeves in this group.";
            wrap.appendChild(empty);
          } else {
            filteredItems.forEach((sleeve) => {
              if (group.scope === "custom") {
                const sleeveBlock = document.createElement("div");
                sleeveBlock.className = "synergy-dialog-sleeve-block";
                const row = document.createElement("div");
                row.className = "synergy-dialog-option-row";
                const isActiveEdit = activeEditorKey === `edit:${normalizeLetter(sleeve.letter)}`;

                if (isActiveEdit) {
                  row.classList.add("synergy-dialog-option-row-active");
                  const { wrap } = createInlineTitleEditor(
                    sleeve.letter,
                    state.editor.title || sleeve.title || "",
                    (value) => {
                      state.editor.title = value;
                    },
                    () => {
                      saveDialogEditor().catch(() => setStatus("Could not save sleeve.", "error"));
                    }
                  );
                  row.appendChild(wrap);
                } else {
                  const btn = createSplitSleeveButton(
                    sleeve.letter,
                    sleeve.title,
                    () => {
                      applySleeveToEditor(sleeve);
                      closeHeaderEditor();
                    }
                  );
                  row.appendChild(btn);
                }

                const actions = document.createElement("div");
                actions.className = "synergy-dialog-row-actions";
                if (isActiveEdit) {
                  const saveBtn = document.createElement("button");
                  saveBtn.type = "button";
                  saveBtn.className = "synergy-dialog-row-save";
                  saveBtn.textContent = getSaveButtonLabel();
                  saveBtn.title = getSaveButtonLabel();
                  saveBtn.addEventListener("click", () => {
                    saveDialogEditor().catch(() => setStatus("Could not save sleeve.", "error"));
                  });
                  actions.appendChild(saveBtn);
                } else {
                  const editBtn = document.createElement("button");
                  editBtn.type = "button";
                  editBtn.className = "synergy-dialog-option-icon";
                  editBtn.textContent = ICON_EDIT;
                  editBtn.setAttribute("aria-label", `Edit title for Career Sleeve ${sleeve.letter}`);
                  editBtn.addEventListener("click", (event) => {
                    event.preventDefault();
                    event.stopPropagation();
                    startEditCustomSleeve(sleeve);
                  });
                  actions.appendChild(editBtn);

                  const deleteBtn = document.createElement("button");
                  deleteBtn.type = "button";
                  deleteBtn.className = "synergy-dialog-option-icon";
                  deleteBtn.textContent = ICON_REMOVE;
                  deleteBtn.setAttribute("aria-label", `Delete Career Sleeve ${sleeve.letter}`);
                  deleteBtn.addEventListener("click", (event) => {
                    event.preventDefault();
                    event.stopPropagation();
                    deleteCustomSleeveFromDialog(sleeve).catch(() => setStatus("Could not delete custom sleeve.", "error"));
                  });
                  actions.appendChild(deleteBtn);
                }
                row.appendChild(actions);
                sleeveBlock.appendChild(row);

                if (isActiveEdit && els.dialogEditorSection) {
                  els.dialogEditorSection.classList.remove("is-hidden");
                  els.dialogEditorSection.classList.add("is-open");
                  sleeveBlock.appendChild(els.dialogEditorSection);
                }

                wrap.appendChild(sleeveBlock);
              } else {
                const btn = createSplitSleeveButton(
                  sleeve.letter,
                  sleeve.title,
                  () => {
                    applySleeveToEditor(sleeve);
                    closeHeaderEditor();
                  }
                );
                wrap.appendChild(btn);
              }
            });
          }
          if (group.scope === "custom") {
            const addBlock = document.createElement("div");
            addBlock.className = "synergy-dialog-sleeve-block";
            const addRow = document.createElement("div");
            addRow.className = "synergy-dialog-option-row";
            const isActiveAdd = activeEditorKey === "add";

            if (isActiveAdd) {
              addRow.classList.add("synergy-dialog-option-row-active");
              const { wrap } = createInlineTitleEditor(
                getNextCustomLetter(),
                state.editor.title || "",
                (value) => {
                  state.editor.title = value;
                },
                () => {
                  saveDialogEditor().catch(() => setStatus("Could not save sleeve.", "error"));
                }
              );
              addRow.appendChild(wrap);

              const actions = document.createElement("div");
              actions.className = "synergy-dialog-row-actions";
              const saveBtn = document.createElement("button");
              saveBtn.type = "button";
              saveBtn.className = "synergy-dialog-row-save";
              saveBtn.textContent = getSaveButtonLabel();
              saveBtn.title = getSaveButtonLabel();
              saveBtn.addEventListener("click", () => {
                saveDialogEditor().catch(() => setStatus("Could not save sleeve.", "error"));
              });
              actions.appendChild(saveBtn);
              addRow.appendChild(actions);
            } else {
              const addBtn = document.createElement("button");
              addBtn.type = "button";
              addBtn.className = "synergy-dialog-add-trigger";
              addBtn.textContent = "+";
              addBtn.setAttribute("aria-label", "Add custom sleeve");
              addBtn.addEventListener("click", () => {
                resetDialogEditor("add", null, true);
                renderLoadDialogList();
                setTimeout(() => {
                  const input = els.loadDialogList.querySelector(".synergy-dialog-inline-title-input");
                  if (input) input.focus();
                }, 20);
              });
              addRow.appendChild(addBtn);
            }
            addBlock.appendChild(addRow);

            if (isActiveAdd && els.dialogEditorSection) {
              els.dialogEditorSection.classList.remove("is-hidden");
              els.dialogEditorSection.classList.add("is-open");
              addBlock.appendChild(els.dialogEditorSection);
            }
            wrap.appendChild(addBlock);
          }
          els.loadDialogList.appendChild(wrap);
        });
      }

      function resetDialogEditor(mode = "add", sleeve = null, visible = false) {
        if (mode === "edit" && sleeve) {
          state.editor.mode = "edit";
          state.editor.letter = normalizeLetter(sleeve.letter || "");
          state.editor.title = String(sleeve.title || "");
          state.editor.terms = dedupeTerms(sleeve.terms || []);
          state.editor.anchor = `edit:${state.editor.letter}`;
        } else {
          state.editor.mode = "add";
          state.editor.letter = "";
          state.editor.title = "";
          state.editor.terms = [];
          state.editor.anchor = "add";
        }
        setDialogEditorVisible(visible);
        renderDialogEditor();
      }

      function startEditCustomSleeve(sleeve) {
        const letter = normalizeLetter(sleeve ? sleeve.letter : "");
        if (!letter || !isCustomLetter(letter)) {
          setStatus("Only custom sleeves (E-Z) can be edited.", "error");
          setDialogNote("Only custom sleeves (E-Z) can be edited.", "error");
          return;
        }
        applySleeveToEditor(sleeve, { silent: true });
        resetDialogEditor("edit", sleeve, true);
        renderLoadDialogList();
        setDialogNote(
          `Editing Career Sleeve ${letter}. Update title and terms, then save your changes.`,
          "info"
        );
        setTimeout(() => {
          const input = els.loadDialogList.querySelector(".synergy-dialog-inline-title-input");
          if (input) input.focus();
        }, 20);
      }

      function renderDialogEditor() {
        renderDialogTerms();
        if (!state.editorVisible) {
          setDialogNote("Click + to add a custom sleeve.", "info");
          return;
        }
        const editor = collectEditor();
        if (editor.mode === "edit" && editor.letter) {
          setDialogNote(
            `Editing Career Sleeve ${editor.letter}. Update title and terms, then save your changes.`,
            "info"
          );
          return;
        }
        setDialogNote(
          `Adding a new custom sleeve. Next available letter: ${getNextCustomLetter()}. Add at least 1 search term, then save.`,
          "info"
        );
      }

      async function saveDialogEditor(options = {}) {
        const silent = Boolean(options.silent);
        const editor = collectEditor();
        if (!editor.title) {
          if (!silent) {
            setStatus("Type a sleeve title before saving.", "error");
            setDialogNote("Title is required before you can save this sleeve.", "error");
          }
          return null;
        }
        if (!editor.terms.length) {
          if (!silent) {
            setStatus("Add at least one search term before saving.", "error");
            setDialogNote("Add at least one search term before saving.", "error");
          }
          return null;
        }

        const payloadBody = {
          title: editor.title,
          terms: editor.terms,
        };
        if (editor.mode === "edit" && isCustomLetter(editor.letter)) {
          payloadBody.letter = editor.letter;
          payloadBody.allow_overwrite = true;
        }

        const res = await fetch("/synergy-sleeves", {
          method: "POST",
          headers: { "Content-Type": "application/json", Accept: "application/json" },
          body: JSON.stringify(payloadBody),
        });
        const payload = await res.json();
        if (!res.ok) {
          if (!silent) {
            const errorMessage = payload.error || "Could not save sleeve.";
            setStatus(errorMessage, "error");
            setDialogNote(errorMessage, "error");
          }
          return null;
        }

        state.catalog = payload.catalog || state.catalog;
        const saved = payload.saved || {};
        const wasEdit = editor.mode === "edit";
        applySleeveToEditor(saved, { silent: true });
        resetDialogEditor("add", null, false);
        renderLoadDialogList();
        if (!silent) {
          const successMessage = wasEdit
            ? `Saved edits to Career Sleeve ${saved.letter || "?"}.`
            : `Added custom Career Sleeve ${saved.letter || "?"}.`;
          setStatus(successMessage, "success");
          setDialogNote(successMessage, "success");
        }
        return saved;
      }

      async function deleteCustomSleeveFromDialog(sleeve) {
        const letter = normalizeLetter(sleeve ? sleeve.letter : "");
        if (!letter || !isCustomLetter(letter)) {
          setStatus("Only custom sleeves (E-Z) can be deleted.", "error");
          setDialogNote("Only custom sleeves (E-Z) can be deleted.", "error");
          return;
        }
        const confirmed = window.confirm(`Delete Career Sleeve ${letter}?`);
        if (!confirmed) {
          return;
        }

        const res = await fetch(`/synergy-sleeves/${encodeURIComponent(letter)}`, {
          method: "DELETE",
          headers: { Accept: "application/json" },
        });
        const payload = await res.json();
        if (!res.ok) {
          const errorMessage = payload.error || "Could not delete custom sleeve.";
          setStatus(errorMessage, "error");
          setDialogNote(errorMessage, "error");
          return;
        }

        state.catalog = payload.catalog || state.catalog;
        if (normalizeLetter(state.current.letter) === letter) {
          state.current.letter = "";
          state.current.title = "";
          state.current.terms = [];
          updateHeaderPreview();
        }
        if (state.editor.mode === "edit" && normalizeLetter(state.editor.letter) === letter) {
          resetDialogEditor("add", null, false);
        }
        renderLoadDialogList();
        setStatus(`Deleted Career Sleeve ${letter}.`, "success");
        setDialogNote(`Deleted Career Sleeve ${letter} successfully.`, "success");
      }

      async function loadCatalog() {
        const res = await fetch("/synergy-sleeves", { headers: { Accept: "application/json" } });
        const payload = await res.json();
        if (!res.ok) throw new Error(payload.error || "Could not load sleeves.");
        state.catalog = payload;
        renderLoadDialogList();
      }

      async function pollProgress(runId) {
        if (!runId) return;
        try {
          const res = await fetch(`/scrape-progress/${encodeURIComponent(runId)}?tail=120`, { headers: { Accept: "application/json" } });
          if (!res.ok) return;
          const payload = await res.json();
          renderEvents(payload.events || []);
          if (payload.summary) renderMetrics(payload.summary);
          if (payload.status === "done" || payload.status === "error") {
            clearInterval(state.progressTimer);
            state.progressTimer = null;
          }
        } catch (_error) {}
      }

      async function runScrape() {
        const current = collectCurrent();
        if (!current.letter) return setStatus("Select or save a Career Sleeve before scraping.", "error", "scrape");
        if (!current.terms.length) return setStatus("Add at least one search term before scraping.", "error", "scrape");
        const effectiveSleeve = isFixedLetter(current.letter) ? current.letter : "E";
        const runId = `synergy-${Date.now().toString(36)}-${Math.random().toString(36).slice(2, 8)}`;
        renderResults([]);
        renderMetrics(null);
        state.localProgressEvents = [];
        state.remoteProgressEvents = [];
        renderEvents();
        setStatus(
          `Starting scrape for Career Sleeve ${current.letter} (using scoring profile ${effectiveSleeve}).`,
          "info",
          "scrape"
        );
        if (state.progressTimer) clearInterval(state.progressTimer);
        state.progressTimer = setInterval(() => pollProgress(runId), 500);
        pollProgress(runId);

        const params = new URLSearchParams({
          run_id: runId,
          sleeve: effectiveSleeve,
          query_terms: current.terms.join(","),
          strict: "0",
          max_results: "200",
        });
        if (!isFixedLetter(current.letter)) {
          params.set("custom_mode", "1");
          params.set("custom_letter", current.letter);
        }

        try {
          const res = await fetch(`/scrape?${params.toString()}`, { headers: { Accept: "application/json" } });
          const payload = await res.json();
          if (!res.ok) {
            if (state.progressTimer) { clearInterval(state.progressTimer); state.progressTimer = null; }
            setStatus(payload.error || "Scrape failed.", "error", "scrape");
            return;
          }
          renderResults(payload.jobs || []);
          renderMetrics(payload.summary || null);
          const total = Array.isArray(payload.jobs) ? payload.jobs.length : 0;
          setStatus(`Scrape completed. Returned ${total} jobs.`, "success", "scrape");
        } catch (_error) {
          if (state.progressTimer) { clearInterval(state.progressTimer); state.progressTimer = null; }
          setStatus("Scrape request failed.", "error", "scrape");
        } finally {
          setTimeout(() => pollProgress(runId), 350);
        }
      }

      function bindEvents() {
        els.closeLoadDialogBtn.addEventListener("click", closeHeaderEditor);
        if (els.loadDialogSearch) {
          els.loadDialogSearch.addEventListener("input", () => {
            state.loadFilter = String(els.loadDialogSearch.value || "");
            renderLoadDialogList();
          });
        }
        els.dialogAddTermBtn.addEventListener("click", () => {
          const term = String(els.dialogTermInput.value || "").trim();
          if (!term) return;
          state.editor.terms = dedupeTerms([...(state.editor.terms || []), term]);
          els.dialogTermInput.value = "";
          renderDialogTerms();
          setDialogNote(`Added term "${term}".`, "success");
        });
        els.dialogGenerateTermsBtn.addEventListener("click", () => {
          generateTermsFromEditorTitle();
        });
        els.dialogTermInput.addEventListener("keydown", (event) => {
          if (event.key === "Enter") { event.preventDefault(); els.dialogAddTermBtn.click(); }
        });
        els.dialogClearTermsBtn.addEventListener("click", () => {
          state.editor.terms = [];
          renderDialogTerms();
          setDialogNote("Cleared all search terms for this editor.", "info");
        });
        els.scrapeNowBtn.addEventListener("click", () => runScrape());
        els.headerEditorTrigger.addEventListener("click", async () => {
          try {
            await loadCatalog();
            openHeaderEditor();
          } catch (error) {
            setStatus(error.message || "Could not open sleeve dialog.", "error");
          }
        });
        els.headerEditorTrigger.addEventListener("keydown", async (event) => {
          if (event.key === "Enter" || event.key === " ") {
            event.preventDefault();
            try {
              await loadCatalog();
              openHeaderEditor();
            } catch (error) {
              setStatus(error.message || "Could not open sleeve dialog.", "error");
            }
          }
        });
        els.loadDialog.addEventListener("cancel", (event) => {
          event.preventDefault();
          closeHeaderEditor();
        });
      }

      async function init() {
        bindEvents();
        resetDialogEditor("add", null, false);
        state.localProgressEvents = [
          {
            message: "Waiting for Career Sleeve selection.",
            type: "info",
            ts: new Date().toISOString(),
          },
        ];
        state.remoteProgressEvents = [];
        renderEvents();
        renderResults([]);
        renderMetrics(null);
        updateHeaderPreview();
        try {
          await loadCatalog();
          setStatus("Catalog loaded. Click the header to set or load a sleeve.", "success");
        } catch (error) {
          setStatus(error.message || "Could not load sleeve catalog.", "error");
        }
      }
      init();
    })();
  </script>
  <script src="{{ url_for('static', filename='script.js') }}"></script>
</body>
</html>
