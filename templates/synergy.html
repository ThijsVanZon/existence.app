<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>2025-2035</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
  <style>
    .synergy-shell { max-width: 920px; margin: 18px auto 32px; }
    .synergy-column {
      --synergy-zircon-deep: #006f75;
      --synergy-heliodor-deep: #8f6800;
      --synergy-rubellite-deep: #8f2344;
      --synergy-amethyst-deep: #452d8f;
      --synergy-inner-radius: 10px;
      border: none; border-radius: 22px; padding: 16px; display: grid; gap: 12px;
      background: linear-gradient(145deg, rgba(var(--white-rgb), 0.78), rgba(var(--white-rgb), 0.58));
      box-shadow: var(--shadow-soft); backdrop-filter: var(--glass-blur); -webkit-backdrop-filter: var(--glass-blur);
    }
    .synergy-sleeve-header {
      margin: 0; padding: 8px 10px; border-radius: var(--synergy-inner-radius); color: var(--white);
      text-shadow: 0 1px 2px rgba(var(--black-rgb), 0.18);
      background: linear-gradient(100deg, rgba(var(--amethyst-rgb), 0.84), rgba(var(--zircon-rgb), 0.68));
    }
    .synergy-row { display: grid; gap: 6px; }
    .synergy-row label { font-weight: 600; color: var(--ink-muted); font-size: 0.85rem; }
    .synergy-inline { display: flex; flex-wrap: wrap; gap: 8px; align-items: center; }
    .synergy-editor-grid { display: grid; grid-template-columns: 180px 1fr; gap: 8px; }
    .synergy-row select, .synergy-row input, .synergy-inline input {
      border: none; border-radius: var(--synergy-inner-radius); padding: 8px 10px; color: var(--ink);
      background: linear-gradient(140deg, rgba(var(--white-rgb), 0.92), rgba(var(--white-rgb), 0.66));
    }
    .synergy-query-box {
      border: none; border-radius: var(--synergy-inner-radius); padding: 10px; display: grid; gap: 8px;
      background: rgba(var(--amethyst-rgb), 0.08);
    }
    .synergy-query-chip {
      display: inline-flex; align-items: center; gap: 4px; border-radius: 999px;
      padding: 4px 6px 4px 4px; background: rgba(var(--amethyst-rgb), 0.14); color: var(--synergy-amethyst-deep);
      font-size: 0.8rem; font-weight: 600; white-space: nowrap;
    }
    .synergy-query-chip-label { margin-right: 0; padding-left: 6px; }
    .synergy-query-chip button {
      border: none; border-radius: 999px; width: 18px; height: 18px; min-width: 18px;
      padding: 0; margin: 0; font-size: 0.8rem; line-height: 1;
      background: rgba(var(--amethyst-rgb), 0.2); color: var(--synergy-amethyst-deep); opacity: 1;
      transform: none; transition: background 0.14s ease;
      margin-left: 0;
      margin-right: 1px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }
    .synergy-query-chip button:hover { transform: none; filter: none; background: rgba(var(--amethyst-rgb), 0.26); }
    .synergy-progress, .synergy-results {
      border: none; border-radius: var(--synergy-inner-radius); padding: 12px; display: grid; gap: 10px;
      background: linear-gradient(140deg, rgba(var(--white-rgb), 0.76), rgba(var(--white-rgb), 0.52));
    }
    .synergy-progress h3, .synergy-results h3 { margin: 0; font-size: 1rem; }
    .synergy-metrics { display: flex; flex-wrap: wrap; gap: 6px; }
    .synergy-metric { border-radius: 999px; padding: 4px 9px; font-size: 0.74rem; font-weight: 800; background: rgba(var(--black-rgb), 0.06); }
    .synergy-metric-pass { background: rgba(var(--zircon-rgb), 0.2); color: var(--synergy-zircon-deep); }
    .synergy-metric-maybe { background: rgba(var(--heliodor-rgb), 0.26); color: var(--synergy-heliodor-deep); }
    .synergy-metric-fail { background: rgba(var(--rubellite-rgb), 0.18); color: var(--synergy-rubellite-deep); }
    .synergy-event-list { margin: 0; padding-left: 18px; display: grid; gap: 4px; font-size: 0.84rem; }
    .synergy-empty { color: var(--ink-muted); font-size: 0.86rem; font-weight: 600; }
    .synergy-result-list { display: grid; gap: 10px; max-height: 760px; overflow-y: auto; padding-right: 4px; }
    .synergy-job-card { border: none; border-radius: var(--synergy-inner-radius); padding: 10px; display: grid; gap: 7px; background: linear-gradient(145deg, rgba(var(--white-rgb), 0.84), rgba(var(--white-rgb), 0.62)); }
    .synergy-job-title { margin: 0; font-size: 0.98rem; color: var(--ink); }
    .synergy-job-meta { margin: 0; color: var(--ink-muted); font-size: 0.84rem; font-weight: 600; }
    .synergy-job-links { display: flex; flex-wrap: wrap; gap: 6px; }
    .synergy-link-btn {
      border: none; border-radius: 999px; padding: 6px 10px; font-size: 0.78rem; font-weight: 800; color: var(--white);
      background: linear-gradient(
        125deg,
        rgb(var(--amethyst-rgb)) 0%,
        rgba(var(--amethyst-rgb), 0.9) 14%,
        rgba(var(--amethyst-rgb), 0.72) 100%
      );
      opacity: 0.9; display: inline-flex; align-items: center; justify-content: center;
    }
    .synergy-link-btn:hover { filter: brightness(0.98); transform: translateY(-1px); opacity: 1; }
    .synergy-column-actions {
      display: flex;
      gap: 8px;
      align-items: center;
      justify-content: flex-start;
    }
    .synergy-dialog {
      border: none; border-radius: 20px; padding: 15px; width: min(680px, calc(100vw - 28px));
      background: rgba(var(--white-rgb), 0.92);
      box-shadow: 0 20px 44px rgba(var(--black-rgb), 0.24);
    }
    .synergy-dialog::backdrop { background: rgba(var(--black-rgb), 0.3); backdrop-filter: blur(4px); -webkit-backdrop-filter: blur(4px); }
    .synergy-dialog-header { display: flex; align-items: center; justify-content: space-between; gap: 10px; margin-bottom: 8px; }
    .synergy-dialog-header h3 { margin: 0; font-size: 1.05rem; }
    .synergy-dialog-list { display: grid; gap: 10px; max-height: 56vh; overflow-y: auto; padding-right: 2px; }
    .synergy-dialog-search {
      width: 100%;
      border: none;
      border-radius: 10px;
      padding: 8px 10px;
      margin-bottom: 0;
      flex: 1 1 auto;
      min-width: 0;
      background: rgba(var(--white-rgb), 0.9);
      color: var(--ink);
    }
    #dialogQueryInput,
    .synergy-location-grid input,
    .synergy-location-range input {
      border: none;
      border-radius: var(--synergy-inner-radius);
      padding: 8px 10px;
      color: var(--ink);
      background: rgba(var(--white-rgb), 0.88);
    }
    .synergy-dialog-search:focus,
    #dialogQueryInput:focus,
    .synergy-location-grid input:focus,
    .synergy-location-range input:focus {
      outline: none;
      box-shadow: inset 0 0 0 2px rgba(var(--amethyst-rgb), 0.22);
    }
    .synergy-dialog-group { display: grid; gap: 6px; }
    .synergy-dialog-group-title { font-size: 0.82rem; color: var(--ink-muted); font-weight: 700; text-transform: uppercase; letter-spacing: 0.04em; }
    .synergy-query-section-title {
      font-size: 0.76rem;
      color: var(--ink-muted);
      font-weight: 700;
      letter-spacing: 0.02em;
      text-transform: uppercase;
    }
    .synergy-dialog-option { width: 100%; text-align: left; }
    .synergy-dialog-option-row {
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .synergy-dialog-option-row-active {
      align-items: stretch;
    }
    .synergy-dialog-sleeve-block {
      display: grid;
      gap: 8px;
    }
    .synergy-dialog-option-main {
      flex: 1 1 auto;
    }
    .synergy-dialog-option-split {
      display: flex;
      align-items: stretch;
      gap: 0;
      padding: 0;
      overflow: hidden;
      border-radius: 10px;
      min-height: 36px;
      background: transparent;
      position: relative;
    }
    .synergy-dialog-option-split-letter {
      width: 36px;
      height: 36px;
      min-width: 36px;
      min-height: 36px;
      flex: 0 0 auto;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-family: "Manrope", sans-serif;
      font-size: 1.05rem;
      font-weight: 800;
      line-height: 1;
      text-align: center;
      color: rgb(var(--white-rgb));
      background: rgb(var(--amethyst-rgb));
      border-radius: 10px;
      user-select: none;
      z-index: 2;
    }
    .synergy-dialog-option-split-title {
      flex: 1 1 auto;
      display: inline-flex;
      align-items: center;
      padding: 0 10px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      font-weight: 700;
      font-size: 0.88rem;
      color: rgb(var(--white-rgb));
      min-height: 36px;
      margin-left: -36px;
      padding-left: 46px;
      border-radius: 10px;
      background: rgba(var(--amethyst-rgb), 0.82);
    }
    .synergy-dialog-inline-title-wrap {
      flex: 1 1 auto;
      min-height: 36px;
      display: flex;
      align-items: stretch;
      gap: 0;
      border: none;
      border-radius: 10px;
      overflow: hidden;
      background: transparent;
      cursor: text;
      transition: filter 0.14s ease, box-shadow 0.14s ease;
    }
    .synergy-dialog-inline-title-wrap:hover {
      filter: brightness(1.02);
    }
    .synergy-dialog-inline-title-wrap:focus-within {
      box-shadow: inset 0 0 0 2px rgba(var(--white-rgb), 0.34);
    }
    .synergy-dialog-inline-title-letter {
      width: 36px;
      height: 36px;
      min-width: 36px;
      min-height: 36px;
      flex: 0 0 auto;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-family: "Manrope", sans-serif;
      font-size: 1.05rem;
      font-weight: 800;
      line-height: 1;
      text-align: center;
      color: rgb(var(--white-rgb));
      background: rgb(var(--amethyst-rgb));
      border-radius: 10px;
      user-select: none;
      z-index: 2;
      transform: translateY(1px);
    }
    .synergy-dialog-inline-title-input {
      flex: 1 1 auto;
      border: none;
      border-radius: 10px;
      min-height: 36px;
      margin-left: -36px;
      padding: 0 10px 0 46px;
      color: rgb(var(--white-rgb));
      font-weight: 700;
      font-size: 0.88rem;
      background: rgba(var(--amethyst-rgb), 0.82);
    }
    .synergy-dialog-inline-title-input::placeholder {
      color: rgba(var(--white-rgb), 0.62);
    }
    .synergy-dialog-inline-title-input:focus {
      outline: none;
      box-shadow: none;
    }
    .synergy-dialog-row-actions {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      flex: 0 0 auto;
    }
    .synergy-dialog-row-save {
      border: none;
      border-radius: 999px;
      width: 62px;
      min-width: 62px;
      padding: 6px 0;
      font-size: 0.74rem;
      font-weight: 800;
      color: var(--white);
      background: rgba(var(--amethyst-rgb), 0.88);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      text-align: center;
    }
    .synergy-dialog-inline-editor {
      overflow: hidden;
      max-height: 0;
      opacity: 0;
      transform: translateY(-4px);
      transition: max-height 0.22s ease, opacity 0.18s ease, transform 0.18s ease;
      pointer-events: none;
    }
    .synergy-dialog-inline-editor.is-open {
      max-height: 560px;
      opacity: 1;
      transform: translateY(0);
      pointer-events: auto;
    }
    .synergy-dialog-option-icon {
      border: none;
      border-radius: 999px;
      width: 28px;
      height: 28px;
      min-width: 28px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-size: 0.95rem;
      font-weight: 800;
      color: var(--synergy-amethyst-deep);
      background: rgba(var(--amethyst-rgb), 0.16);
      cursor: pointer;
      transition: background 0.14s ease;
    }
    .synergy-dialog-option-icon:hover {
      background: rgba(var(--amethyst-rgb), 0.24);
      transform: none;
    }
    .synergy-dialog-custom-create {
      display: grid;
      gap: 8px;
      margin-top: 0;
      padding: 0;
      border-radius: var(--synergy-inner-radius);
      background: transparent;
    }
    .synergy-dialog-custom-create.is-hidden {
      display: none;
    }
    .synergy-dialog-custom-note {
      color: var(--synergy-heliodor-deep);
      font-size: 0.8rem;
      font-weight: 600;
      border-radius: 8px;
      padding: 6px 8px;
      background: rgba(var(--heliodor-rgb), 0.22);
    }
    .synergy-dialog-custom-note.is-info {
      color: var(--synergy-heliodor-deep);
      background: rgba(var(--heliodor-rgb), 0.22);
    }
    .synergy-dialog-custom-note.is-success {
      color: var(--synergy-zircon-deep);
      background: rgba(var(--zircon-rgb), 0.22);
    }
    .synergy-dialog-custom-note.is-error {
      color: var(--synergy-rubellite-deep);
      background: rgba(var(--rubellite-rgb), 0.18);
    }
    .synergy-query-chip-list {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      align-items: center;
    }
    .synergy-dialog-editor-actions {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
    }
    .synergy-dialog-editor-actions button {
      flex: 1 1 180px;
    }
    .synergy-dialog-icon-trigger,
    .synergy-dialog-add-trigger,
    .synergy-dialog-close-trigger {
      width: 36px;
      height: 36px;
      min-width: 36px;
      border: none;
      border-radius: 10px;
      padding: 0;
      color: rgba(var(--white-rgb), 0.98);
      background: rgba(var(--amethyst-rgb), 0.9);
      font-family: "Manrope", sans-serif;
      font-weight: 800;
      font-size: 1.05rem;
      line-height: 1;
      text-align: center;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      align-self: flex-start;
      cursor: pointer;
      opacity: 1;
    }
    .synergy-dialog-icon-trigger:hover {
      filter: brightness(0.92);
      transform: none;
    }
    .synergy-dialog-add-trigger {
      font-size: 1.18rem;
      background: rgb(var(--amethyst-rgb));
    }
    .synergy-dialog-add-trigger:hover {
      background: rgb(var(--amethyst-rgb));
      filter: brightness(0.9);
      transform: none;
    }
    .synergy-dialog-close-trigger {
      margin-left: auto;
      background: rgba(var(--rubellite-rgb), 0.9);
      color: rgba(var(--white-rgb), 0.98);
      font-size: 1.18rem;
    }
    .synergy-dialog-close-trigger:hover {
      background: rgba(var(--rubellite-rgb), 0.9);
      filter: brightness(0.9);
      transform: none;
    }
    .synergy-location-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
      margin-top: 4px;
    }
    .synergy-location-grid input,
    .synergy-location-range input {
      width: 100%;
    }
    .synergy-location-range {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
      margin-top: 6px;
    }
    .synergy-field-stack {
      display: grid;
      gap: 4px;
    }
    .synergy-field-stack label {
      font-size: 0.76rem;
      color: var(--ink-muted);
      font-weight: 700;
      letter-spacing: 0.02em;
      text-transform: uppercase;
    }
    @media (max-width: 720px) {
      .synergy-editor-grid { grid-template-columns: 1fr; }
      .synergy-shell { margin-top: 12px; }
      .synergy-location-grid,
      .synergy-location-range { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <a href="{{ url_for('index') }}"><h1>Timeline</h1></a>
  <nav class="timeline" aria-label="synergy timeline">
    <div class="sub-decade-container"><span class="sub-decade">2025</span></div>
    <div class="main-decade-container highlight"><span class="main-decade">SYNERGY</span></div>
    <div class="sub-decade-container"><span class="sub-decade">2035</span></div>
  </nav>

  <main class="synergy-shell">
    <section class="synergy-column">
      <header
        id="sleeveHeader"
        class="synergy-sleeve-header"
        aria-label="Active career sleeve"
      >
        <span id="headerName" class="sleeve-header-name">No Career Sleeve selected</span>
        <span id="headerCode" class="sleeve-header-code">Career Sleeve ?</span>
      </header>

      <div class="synergy-column-actions">
        <button id="changeSleeveBtn" type="button">Change Career Sleeve</button>
        <button id="scrapeNowBtn" type="button">Scrape Job Openings</button>
        <button id="scrapeUltraFastBtn" type="button">Scrape Ultra Fast</button>
      </div>

      <section class="synergy-progress">
        <h3>Scrape Progress</h3>
        <div id="metricBadges" class="synergy-metrics"></div>
        <ul id="progressEvents" class="synergy-event-list"></ul>
      </section>

      <section class="synergy-results">
        <h3>Results</h3>
        <div id="resultList" class="synergy-result-list"></div>
      </section>
    </section>
  </main>

  <dialog id="loadDialog" class="synergy-dialog">
    <div class="synergy-dialog-header">
      <input id="loadDialogSearch" class="synergy-dialog-search" type="text" autocomplete="off" placeholder="Search by letter or title...">
      <button
        id="closeLoadDialogBtn"
        class="synergy-dialog-icon-trigger synergy-dialog-close-trigger"
        type="button"
        aria-label="Close Career Sleeve editor"
        title="Close"
      >&times;</button>
    </div>
    <div id="loadDialogList" class="synergy-dialog-list"></div>
    <section id="dialogEditorSection" class="synergy-dialog-inline-editor synergy-dialog-custom-create is-hidden">
      <div class="synergy-query-box">
        <div id="dialogCustomNote" class="synergy-dialog-custom-note is-info">Click + to add a custom Career Sleeve.</div>
        <div class="synergy-query-section-title">SEARCH QUERIES</div>
        <div id="dialogQueryChipList" class="synergy-query-chip-list"></div>
        <div class="synergy-inline">
          <input id="dialogQueryInput" type="text" autocomplete="off" placeholder="Type search query and press Enter">
        </div>
        <div class="synergy-dialog-editor-actions">
          <button id="dialogAddQueryBtn" type="button">Add query</button>
          <button id="dialogGenerateQueriesBtn" type="button">Generate queries</button>
          <button id="dialogClearQueriesBtn" type="button">Clear queries</button>
        </div>
        <div class="synergy-location-grid">
          <div class="synergy-field-stack">
            <label for="dialogCountriesInput">Preferred Countries</label>
            <input id="dialogCountriesInput" type="text" autocomplete="off" placeholder="e.g. Germany, Spain, Japan">
          </div>
          <div class="synergy-field-stack">
            <label for="dialogRegionsInput">Preferred Regions</label>
            <input id="dialogRegionsInput" type="text" autocomplete="off" placeholder="e.g. EMEA, APAC, LATAM">
          </div>
        </div>
        <div class="synergy-location-range">
          <div class="synergy-field-stack">
            <label for="dialogAbroadMinInput">Abroad % Min</label>
            <input id="dialogAbroadMinInput" type="number" min="0" max="100" step="1" placeholder="0">
          </div>
          <div class="synergy-field-stack">
            <label for="dialogAbroadMaxInput">Abroad % Max</label>
            <input id="dialogAbroadMaxInput" type="number" min="0" max="100" step="1" placeholder="100">
          </div>
        </div>
      </div>
    </section>
  </dialog>

  <script>
    (() => {
      const state = {
        catalog: { fixed: [], custom: [], all: [] },
        current: {
          letter: "",
          title: "",
          queries: [],
          location_preferences: { countries: [], regions: [], abroad_min_percent: 0, abroad_max_percent: 100 },
        },
        editor: {
          mode: "add",
          letter: "",
          title: "",
          queries: [],
          location_preferences: { countries: [], regions: [], abroad_min_percent: 0, abroad_max_percent: 100 },
          anchor: "",
        },
        editorVisible: false,
        progressTimer: null,
        loadFilter: "",
        localProgressEvents: [],
        remoteProgressEvents: [],
        scrapeBusy: false,
      };
      const els = {
        changeSleeveBtn: document.getElementById("changeSleeveBtn"),
        scrapeNowBtn: document.getElementById("scrapeNowBtn"),
        scrapeUltraFastBtn: document.getElementById("scrapeUltraFastBtn"),
        metricBadges: document.getElementById("metricBadges"),
        progressEvents: document.getElementById("progressEvents"),
        resultList: document.getElementById("resultList"),
        headerName: document.getElementById("headerName"),
        headerCode: document.getElementById("headerCode"),
        loadDialog: document.getElementById("loadDialog"),
        loadDialogList: document.getElementById("loadDialogList"),
        loadDialogSearch: document.getElementById("loadDialogSearch"),
        dialogEditorSection: document.getElementById("dialogEditorSection"),
        closeLoadDialogBtn: document.getElementById("closeLoadDialogBtn"),
        dialogQueryChipList: document.getElementById("dialogQueryChipList"),
        dialogQueryInput: document.getElementById("dialogQueryInput"),
        dialogAddQueryBtn: document.getElementById("dialogAddQueryBtn"),
        dialogGenerateQueriesBtn: document.getElementById("dialogGenerateQueriesBtn"),
        dialogClearQueriesBtn: document.getElementById("dialogClearQueriesBtn"),
        dialogCustomNote: document.getElementById("dialogCustomNote"),
        dialogCountriesInput: document.getElementById("dialogCountriesInput"),
        dialogRegionsInput: document.getElementById("dialogRegionsInput"),
        dialogAbroadMinInput: document.getElementById("dialogAbroadMinInput"),
        dialogAbroadMaxInput: document.getElementById("dialogAbroadMaxInput"),
      };

      const normalizeLetter = (v) => (/^[A-Z]$/.test(String(v || "").trim().toUpperCase()) ? String(v || "").trim().toUpperCase() : "");
      const isFixedLetter = (l) => ["A", "B", "C", "D"].includes(l);
      const isCustomLetter = (l) => /^[A-Z]$/.test(l || "") && l >= "E";
      const LAST_SLEEVE_STORAGE_KEY = "existence.synergy.last_sleeve.v1";
      const dedupeQueries = (arr) => {
        const seen = new Set();
        const out = [];
        (arr || []).forEach((raw) => {
          const t = String(raw || "").trim();
          if (t.length < 2) return;
          const k = t.toLowerCase();
          if (seen.has(k)) return;
          seen.add(k);
          out.push(t);
        });
        return out;
      };
      const parseCommaList = (value) =>
        dedupeQueries(
          String(value || "")
            .split(/[,;\n\r|]+/g)
            .map((part) => String(part || "").trim())
            .filter(Boolean)
        );
      const clampPercent = (value, fallback) => {
        const numeric = Number(value);
        if (!Number.isFinite(numeric)) return fallback;
        const rounded = Math.round(numeric);
        return Math.max(0, Math.min(100, rounded));
      };
      const defaultLocationPreferences = () => ({
        countries: [],
        regions: [],
        abroad_min_percent: 0,
        abroad_max_percent: 100,
      });
      const normalizeLocationPreferences = (raw) => {
        const source = raw && typeof raw === "object" ? raw : {};
        const normalized = defaultLocationPreferences();
        normalized.countries = dedupeQueries(source.countries || []);
        normalized.regions = dedupeQueries(source.regions || []);
        normalized.abroad_min_percent = clampPercent(source.abroad_min_percent, 0);
        normalized.abroad_max_percent = clampPercent(source.abroad_max_percent, 100);
        if (normalized.abroad_max_percent < normalized.abroad_min_percent) {
          normalized.abroad_max_percent = normalized.abroad_min_percent;
        }
        return normalized;
      };
      const formatLocationList = (arr) => dedupeQueries(arr || []).join(", ");
      const persistLastLoadedSleeve = (letter) => {
        const normalized = normalizeLetter(letter);
        if (!normalized) return;
        try {
          localStorage.setItem(LAST_SLEEVE_STORAGE_KEY, normalized);
        } catch (_error) {}
      };
      const loadLastLoadedSleeve = () => {
        try {
          return normalizeLetter(localStorage.getItem(LAST_SLEEVE_STORAGE_KEY) || "");
        } catch (_error) {
          return "";
        }
      };
      const findSleeveByLetter = (letter) =>
        (state.catalog.all || []).find((entry) => normalizeLetter(entry && entry.letter) === normalizeLetter(letter)) || null;
      const findCustom = (l) => (state.catalog.custom || []).find((x) => x.letter === l) || null;
      const ICON_EDIT = "\u270E";
      const ICON_REMOVE = "\u00D7";
      const getNextCustomLetter = () => {
        const usedCustomLetters = new Set(
          (state.catalog.custom || [])
            .map((entry) => normalizeLetter(entry && entry.letter))
            .filter(Boolean)
        );
        for (let code = 69; code <= 90; code += 1) {
          const letter = String.fromCharCode(code);
          if (!usedCustomLetters.has(letter)) return letter;
        }
        return "?";
      };
      const getSaveButtonLabel = () => {
        return "Save";
      };
      const collectCurrent = () => ({
        letter: normalizeLetter(state.current.letter),
        title: String(state.current.title || "").trim(),
        queries: dedupeQueries(state.current.queries),
        location_preferences: normalizeLocationPreferences(state.current.location_preferences),
      });
      const collectEditor = () => ({
        mode: state.editor.mode === "edit" ? "edit" : "add",
        letter: normalizeLetter(state.editor.letter),
        title: String(state.editor.title || "").trim(),
        queries: dedupeQueries(state.editor.queries),
        location_preferences: normalizeLocationPreferences(state.editor.location_preferences),
      });

      function setStatus(msg, type = "info", scope = "ui") {
        const text = String(msg || "").trim();
        if (!text) return;
        if (scope !== "scrape") return;
        state.localProgressEvents.push({
          message: text,
          type,
          ts: new Date().toISOString(),
        });
        renderEvents();
      }

      function setDialogNote(msg, type = "info") {
        if (!els.dialogCustomNote) return;
        els.dialogCustomNote.textContent = String(msg || "").trim();
        els.dialogCustomNote.classList.remove("is-info", "is-success", "is-error");
        if (type === "success") {
          els.dialogCustomNote.classList.add("is-success");
          return;
        }
        if (type === "error") {
          els.dialogCustomNote.classList.add("is-error");
          return;
        }
        els.dialogCustomNote.classList.add("is-info");
      }

      function createInlineTitleEditor(letterValue, initialTitle, onInput, onSubmit) {
        const wrap = document.createElement("div");
        wrap.className = "synergy-dialog-inline-title-wrap";

        const letter = document.createElement("span");
        letter.className = "synergy-dialog-inline-title-letter";
        letter.textContent = normalizeLetter(letterValue) || "?";

        const input = document.createElement("input");
        input.type = "text";
        input.maxLength = 120;
        input.className = "synergy-dialog-inline-title-input";
        input.value = String(initialTitle || "");
        input.placeholder = "Type Career Sleeve title...";
        input.addEventListener("input", () => {
          onInput(String(input.value || "").slice(0, 120));
        });
        input.addEventListener("keydown", (event) => {
          if (event.key === "Enter") {
            event.preventDefault();
            onSubmit();
          }
        });

        const focusInput = () => input.focus();
        wrap.addEventListener("click", focusInput);
        letter.addEventListener("click", (event) => {
          event.preventDefault();
          focusInput();
        });

        wrap.appendChild(letter);
        wrap.appendChild(input);
        return { wrap, input };
      }

      function createSplitSleeveButton(letterValue, titleValue, onClick) {
        const btn = document.createElement("button");
        btn.type = "button";
        btn.className = "synergy-dialog-option synergy-dialog-option-main synergy-dialog-option-split";

        const letter = document.createElement("span");
        letter.className = "synergy-dialog-option-split-letter";
        letter.textContent = normalizeLetter(letterValue) || "?";

        const title = document.createElement("span");
        title.className = "synergy-dialog-option-split-title";
        title.textContent = String(titleValue || "").trim() || "Untitled Career Sleeve";

        btn.appendChild(letter);
        btn.appendChild(title);
        btn.addEventListener("click", onClick);
        return btn;
      }

      function renderDialogQueries() {
        els.dialogQueryChipList.innerHTML = "";
        const editor = collectEditor();
        if (!editor.queries.length) {
          const empty = document.createElement("div");
          empty.className = "synergy-empty";
          empty.textContent = "No search queries configured.";
          els.dialogQueryChipList.appendChild(empty);
          return;
        }
        editor.queries.forEach((query) => {
          const chip = document.createElement("span");
          chip.className = "synergy-query-chip";
          const label = document.createElement("span");
          label.className = "synergy-query-chip-label";
          label.textContent = query;
          chip.appendChild(label);
          const remove = document.createElement("button");
          remove.type = "button";
          remove.textContent = ICON_REMOVE;
          remove.setAttribute("aria-label", `Remove search query ${query}`);
          remove.addEventListener("click", () => {
            state.editor.queries = state.editor.queries.filter((q) => q.toLowerCase() !== query.toLowerCase());
            renderDialogQueries();
            setDialogNote(`Removed search query "${query}".`, "info");
          });
          chip.appendChild(remove);
          els.dialogQueryChipList.appendChild(chip);
        });
      }

      function syncDialogLocationInputs() {
        const prefs = normalizeLocationPreferences(state.editor.location_preferences);
        if (els.dialogCountriesInput) {
          els.dialogCountriesInput.value = formatLocationList(prefs.countries);
        }
        if (els.dialogRegionsInput) {
          els.dialogRegionsInput.value = formatLocationList(prefs.regions);
        }
        if (els.dialogAbroadMinInput) {
          els.dialogAbroadMinInput.value = String(prefs.abroad_min_percent);
        }
        if (els.dialogAbroadMaxInput) {
          els.dialogAbroadMaxInput.value = String(prefs.abroad_max_percent);
        }
      }

      function setEditorLocationPreferencesFromInputs() {
        const nextPrefs = normalizeLocationPreferences({
          countries: parseCommaList(els.dialogCountriesInput ? els.dialogCountriesInput.value : ""),
          regions: parseCommaList(els.dialogRegionsInput ? els.dialogRegionsInput.value : ""),
          abroad_min_percent: clampPercent(
            els.dialogAbroadMinInput ? els.dialogAbroadMinInput.value : 0,
            0
          ),
          abroad_max_percent: clampPercent(
            els.dialogAbroadMaxInput ? els.dialogAbroadMaxInput.value : 100,
            100
          ),
        });
        state.editor.location_preferences = nextPrefs;
        syncDialogLocationInputs();
      }

      function openHeaderEditor() {
        state.loadFilter = "";
        if (els.loadDialogSearch) {
          els.loadDialogSearch.value = "";
        }
        resetDialogEditor("add", null, false);
        renderLoadDialogList();
        if (typeof els.loadDialog.showModal === "function") {
          els.loadDialog.showModal();
        } else {
          els.loadDialog.setAttribute("open", "open");
        }
        if (els.loadDialogSearch) {
          setTimeout(() => els.loadDialogSearch.focus(), 30);
        }
      }

      function closeHeaderEditor() {
        setDialogEditorVisible(false);
        if (typeof els.loadDialog.close === "function") {
          els.loadDialog.close();
        } else {
          els.loadDialog.removeAttribute("open");
        }
      }

      function setDialogEditorVisible(visible) {
        state.editorVisible = Boolean(visible);
        if (!els.dialogEditorSection) return;
        els.dialogEditorSection.classList.toggle("is-hidden", !state.editorVisible);
        els.dialogEditorSection.classList.toggle("is-open", state.editorVisible);
        if (!state.editorVisible) {
          setDialogNote("Click + to add a custom Career Sleeve.", "info");
        }
      }

      function updateHeaderPreview() {
        const letter = normalizeLetter(state.current.letter);
        const inputTitle = String(state.current.title || "").trim();
        const title = inputTitle || "No Career Sleeve selected";
        els.headerName.textContent = title;
        els.headerCode.textContent = letter ? `Career Sleeve ${letter}` : "Career Sleeve ?";
      }

      function applySleeveToEditor(sleeve, options = {}) {
        if (!sleeve) return;
        state.current.letter = normalizeLetter(sleeve.letter || "");
        state.current.title = String(sleeve.title || "");
        state.current.queries = dedupeQueries(sleeve.queries || []);
        state.current.location_preferences = normalizeLocationPreferences(sleeve.location_preferences);
        persistLastLoadedSleeve(state.current.letter);
        updateHeaderPreview();
        if (!options.silent) {
          const suffix = sleeve.locked ? "(fixed)" : "(custom)";
          setStatus(`Loaded Career Sleeve ${sleeve.letter} ${suffix}.`, "success");
          setDialogNote(`Loaded Career Sleeve ${sleeve.letter} ${suffix}.`, "success");
        }
      }

      function guessQueriesFromTitle(title, letter) {
        const fixedByLetter = (state.catalog.fixed || []).find((entry) => entry.letter === letter);
        if (fixedByLetter && Array.isArray(fixedByLetter.queries) && fixedByLetter.queries.length) {
          return fixedByLetter.queries.slice(0, 8);
        }

        const lowerTitle = String(title || "").toLowerCase().trim();
        if (!lowerTitle) return [];

        const tokens = Array.from(
          new Set(
            lowerTitle
              .split(/[^a-z0-9]+/g)
              .map((token) => token.trim())
              .filter(Boolean)
          )
        );

        const domainPresets = [
          {
            id: "music",
            keywords: ["music", "festival", "concert", "tour", "venue", "artist", "event", "live"],
            baseQueries: [
              "music event operations",
              "festival producer",
              "concert production",
              "live production",
            ],
            intentQueries: {
              creative: ["creative production", "artist liaison", "show design coordination"],
              operations: ["show operations", "stage operations", "tour logistics"],
              analyst: ["audience insights analyst", "event performance analysis", "ticketing analytics"],
              technical: ["technical producer", "audio visual live systems", "show control systems"],
              strategy: ["festival programming strategy", "venue partnership strategy", "portfolio planning live events"],
            },
          },
          {
            id: "destinations",
            keywords: ["theme", "park", "attraction", "guest", "destination", "resort", "immersive", "ride"],
            baseQueries: [
              "theme park operations",
              "attractions operations",
              "guest experience",
              "destination operations",
            ],
            intentQueries: {
              creative: ["immersive experience design", "show quality creative", "guest journey design"],
              operations: ["ride operations", "park operations", "resort operations"],
              analyst: ["guest insights analyst", "queue analytics", "experience performance analysis"],
              technical: ["attractions systems operations", "show systems technician", "safety systems operations"],
              strategy: ["destination strategy", "experience portfolio planning", "operations excellence parks"],
            },
          },
          {
            id: "datacenter",
            keywords: ["data", "center", "centre", "facility", "critical", "infrastructure", "commissioning", "uptime"],
            baseQueries: [
              "data center operations",
              "critical facilities technician",
              "mission critical operations",
              "compute infrastructure operations",
            ],
            intentQueries: {
              creative: ["technical storytelling infrastructure", "enablement content infrastructure"],
              operations: ["facility operations", "capacity expansion data center", "change management facilities"],
              analyst: ["capacity analyst data center", "infrastructure operations analyst", "reliability analytics"],
              technical: ["commissioning engineer data center", "site reliability engineer infrastructure", "electrical mechanical operations"],
              strategy: ["infrastructure strategy", "network capacity planning", "operations program management"],
            },
          },
          {
            id: "supply",
            keywords: ["supply", "chain", "logistics", "vendor", "distribution", "ecosystem", "partner", "fulfillment"],
            baseQueries: [
              "supply chain operations",
              "logistics operations",
              "vendor operations",
              "partner operations",
            ],
            intentQueries: {
              creative: ["service design operations", "experience design logistics"],
              operations: ["distribution operations", "rollout operations", "implementation supply chain"],
              analyst: ["supply chain analyst", "logistics performance analyst", "demand planning analyst"],
              technical: ["automation operations logistics", "warehouse systems operations", "integration specialist supply chain"],
              strategy: ["ecosystem strategy", "network optimization strategy", "procurement strategy operations"],
            },
          },
          {
            id: "generic",
            keywords: [],
            baseQueries: [
              "operations manager",
              "program manager",
              "delivery operations",
              "cross-functional execution",
            ],
            intentQueries: {
              creative: ["creative producer", "experience design", "content operations"],
              operations: ["process improvement", "workflow operations", "implementation manager"],
              analyst: ["business analyst", "operations analyst", "data insights analyst"],
              technical: ["technical specialist", "systems operations", "integration engineer"],
              strategy: ["strategy and operations", "program strategy", "transformation lead"],
            },
          },
        ];
        const intentProfiles = [
          {
            id: "creative",
            keywords: ["creative", "producer", "content", "brand", "experience", "story", "design"],
            globalQueries: ["creative operations", "content delivery", "experience programming"],
          },
          {
            id: "operations",
            keywords: ["operations", "ops", "coordinator", "manager", "execution", "delivery", "implementation"],
            globalQueries: ["operations excellence", "cross-functional operations", "service delivery"],
          },
          {
            id: "analyst",
            keywords: ["analyst", "analysis", "insights", "planning", "intelligence", "reporting"],
            globalQueries: ["operations analytics", "performance insights", "data-driven decisions"],
          },
          {
            id: "technical",
            keywords: ["engineer", "technical", "infrastructure", "systems", "commissioning", "reliability", "automation"],
            globalQueries: ["technical operations", "systems reliability", "process automation"],
          },
          {
            id: "strategy",
            keywords: ["strategy", "strategic", "program", "portfolio", "transformation", "growth", "lead"],
            globalQueries: ["strategy and operations", "program governance", "portfolio execution"],
          },
        ];

        let selectedDomain = domainPresets[domainPresets.length - 1];
        let selectedDomainScore = -1;
        for (const preset of domainPresets) {
          const score = preset.keywords.reduce((acc, keyword) => acc + (lowerTitle.includes(keyword) ? 1 : 0), 0);
          if (score > selectedDomainScore) {
            selectedDomain = preset;
            selectedDomainScore = score;
          }
        }

        const rankedIntents = intentProfiles
          .map((profile) => ({
            id: profile.id,
            score: profile.keywords.reduce((acc, keyword) => acc + (lowerTitle.includes(keyword) ? 1 : 0), 0),
            profile,
          }))
          .sort((a, b) => b.score - a.score);

        const activeIntents = rankedIntents
          .filter((entry) => entry.score > 0)
          .slice(0, 2);
        if (!activeIntents.length) {
          const defaultIntent = intentProfiles.find((profile) => profile.id === "operations") || intentProfiles[0];
          activeIntents.push({ id: "operations", score: 0, profile: defaultIntent });
        }

        const generated = [...selectedDomain.baseQueries];
        for (const intent of activeIntents) {
          const intentDomainQueries = (selectedDomain.intentQueries || {})[intent.id] || [];
          generated.push(...intentDomainQueries);
          generated.push(...(intent.profile.globalQueries || []));
        }

        const stopwords = new Set([
          "and", "the", "for", "with", "from", "into", "across", "career", "sleeve", "role",
          "senior", "junior", "lead", "manager", "specialist", "associate",
        ]);
        const candidateTokens = tokens
          .filter((token) => token.length >= 3 && !stopwords.has(token) && !/^\d+$/.test(token))
          .slice(0, 4);
        const primaryIntentId = activeIntents[0].id;
        const tokenSuffixMap = {
          creative: ["creative production", "experience design", "content operations"],
          operations: ["operations", "delivery", "coordination"],
          analyst: ["analysis", "analytics", "insights"],
          technical: ["systems", "infrastructure", "engineering"],
          strategy: ["strategy", "program", "planning"],
        };
        const suffixes = tokenSuffixMap[primaryIntentId] || tokenSuffixMap.operations;
        for (const token of candidateTokens) {
          for (const suffix of suffixes) {
            generated.push(`${token} ${suffix}`);
          }
        }
        generated.push(lowerTitle);
        generated.push(`cross-functional ${primaryIntentId}`);
        generated.push("stakeholder alignment");
        return dedupeQueries(generated).slice(0, 12);
      }

      function generateQueriesFromEditorTitle() {
        const editor = collectEditor();
        if (!editor.title) {
          setStatus("Set a Career Sleeve title first, then generate search queries.", "error");
          setDialogNote("Set a Career Sleeve title first, then generate search queries.", "error");
          return;
        }
        const generated = guessQueriesFromTitle(editor.title, editor.letter);
        if (!generated.length) {
          setStatus("Could not generate search queries from this title.", "error");
          setDialogNote("Could not generate search queries from this title.", "error");
          return;
        }
        state.editor.queries = dedupeQueries([...(state.editor.queries || []), ...generated]);
        renderDialogQueries();
        setStatus(`Generated ${generated.length} search queries locally (free, no paid API).`, "success");
        setDialogNote(`Generated ${generated.length} search queries. Review and save when ready.`, "success");
      }

      function renderMetrics(summary) {
        els.metricBadges.innerHTML = "";
        if (!summary) return;
        const items = [
          ["RAW", summary.raw_count ?? 0, ""],
          ["DEDUPED", summary.deduped_count ?? 0, ""],
          ["PASS", summary.pass_count ?? 0, "synergy-metric-pass"],
          ["MAYBE", summary.maybe_count ?? 0, "synergy-metric-maybe"],
          ["FAIL", summary.fail_count ?? 0, "synergy-metric-fail"],
        ];
        items.forEach(([label, value, cls]) => {
          const b = document.createElement("span");
          b.className = `synergy-metric ${cls}`.trim();
          b.textContent = `${label} ${value}`;
          els.metricBadges.appendChild(b);
        });
      }

      function renderEvents(events) {
        if (Array.isArray(events)) {
          state.remoteProgressEvents = events.slice();
        }
        els.progressEvents.innerHTML = "";
        const combined = [
          ...(state.localProgressEvents || []),
          ...(state.remoteProgressEvents || []),
        ];
        const list = combined
          .slice()
          .sort((a, b) => {
            const ta = Date.parse(String((a && a.ts) || "")) || 0;
            const tb = Date.parse(String((b && b.ts) || "")) || 0;
            return ta - tb;
          })
          .slice(-120);
        if (!list.length) {
          const li = document.createElement("li");
          li.className = "synergy-empty";
          li.textContent = "Waiting for Career Sleeve selection.";
          els.progressEvents.appendChild(li);
          return;
        }
        list.forEach((event) => {
          const li = document.createElement("li");
          li.textContent = event && event.message ? event.message : "Update";
          els.progressEvents.appendChild(li);
        });
      }

      function buildCompanyOpeningUrl(job) {
        const p = new URLSearchParams();
        if (job.company_url) p.set("company_url", job.company_url);
        if (job.indeed_url) p.set("indeed_url", job.indeed_url);
        if (job.linkedin_url) p.set("linkedin_url", job.linkedin_url);
        if (job.url) p.set("job_url", job.url);
        const q = p.toString();
        return q ? `/company-opening?${q}` : "";
      }

      function formatDistanceFromHome(value) {
        const numeric = Number(value);
        if (!Number.isFinite(numeric)) return "";
        const rounded = numeric >= 100 ? Math.round(numeric) : Math.round(numeric * 10) / 10;
        const display = Number.isInteger(rounded) ? String(rounded) : rounded.toFixed(1);
        return `${display}km from home`;
      }

      const FIELD_SEPARATOR = " \u00B7 ";

      function formatAbroadSummary(job) {
        const scoreValue = Number(job && job.abroad_score);
        const scoreText = Number.isFinite(scoreValue)
          ? `${Math.round(scoreValue * 10) / 10}/4`
          : "0/4";
        const identifiers = Array.isArray(job && job.abroad_identifiers) && job.abroad_identifiers.length
          ? job.abroad_identifiers
          : (Array.isArray(job && job.abroad_badges) ? job.abroad_badges : []);
        const parts = [`Abroad ${scoreText}`];
        if (identifiers.length) {
          parts.push(`Identifiers ${identifiers.slice(0, 4).join(", ")}`);
        }
        if (job && job.abroad_percentage_text) {
          parts.push(`Travel ${job.abroad_percentage_text}`);
        }
        const geo = Array.isArray(job && job.abroad_locations)
          ? job.abroad_locations.slice(0, 3).join(", ")
          : "";
        if (geo) {
          parts.push(`Geo ${geo}`);
        }
        return parts.join(FIELD_SEPARATOR);
      }

      function formatConfidenceSummary(job) {
        const sleeveScoreValue = Number((job && job.career_sleeve_fit_score) ?? (job && job.primary_career_sleeve_score));
        const sleeveScoreText = Number.isFinite(sleeveScoreValue) ? `${Math.round(sleeveScoreValue * 10) / 10}/5` : "0/5";
        const sleevePct = Number(job && job.career_sleeve_fit_confidence_pct);
        const sleeveBand = String((job && job.career_sleeve_fit_confidence_band) || "").trim().toLowerCase();
        const sleeveMeta = [];
        if (Number.isFinite(sleevePct)) sleeveMeta.push(`${Math.max(0, Math.min(100, Math.round(sleevePct)))}%`);
        if (sleeveBand) sleeveMeta.push(sleeveBand);

        const abroadScoreValue = Number(job && job.abroad_preferences_fit_score);
        const abroadScoreText = Number.isFinite(abroadScoreValue) ? `${Math.round(abroadScoreValue * 10) / 10}/5` : "0/5";
        const abroadPct = Number(job && job.abroad_preferences_fit_confidence_pct);
        const abroadBand = String((job && job.abroad_preferences_fit_confidence_band) || "").trim().toLowerCase();
        const abroadModeRaw = String((job && job.abroad_preferences_fit_mode) || "").trim().toLowerCase();
        const abroadMode = abroadModeRaw === "custom_preferences" ? "custom preferences" : (abroadModeRaw ? "general signal" : "");
        const abroadMeta = [];
        if (Number.isFinite(abroadPct)) abroadMeta.push(`${Math.max(0, Math.min(100, Math.round(abroadPct)))}%`);
        if (abroadBand) abroadMeta.push(abroadBand);
        if (abroadMode) abroadMeta.push(abroadMode);

        const parts = [];
        parts.push(`Career Sleeve Fit ${sleeveScoreText}${sleeveMeta.length ? ` (${sleeveMeta.join(", ")})` : ""}`);
        parts.push(`Abroad Preferences Fit ${abroadScoreText}${abroadMeta.length ? ` (${abroadMeta.join(", ")})` : ""}`);
        return parts.join(FIELD_SEPARATOR);
      }

      function renderResults(jobs) {
        els.resultList.innerHTML = "";
        if (!Array.isArray(jobs) || !jobs.length) {
          const empty = document.createElement("div");
          empty.className = "synergy-empty";
          empty.textContent = "No jobs returned.";
          els.resultList.appendChild(empty);
          return;
        }
        jobs.forEach((job) => {
          const card = document.createElement("article");
          card.className = "synergy-job-card";
          const title = document.createElement("h4");
          title.className = "synergy-job-title";
          title.textContent = job.title || "Unknown role";
          card.appendChild(title);
          const distanceLabel = formatDistanceFromHome(job.distance_from_home_km);
          const company = document.createElement("p");
          company.className = "synergy-job-meta";
          company.textContent = [
            job.company || "Unknown company",
            job.location || job.main_location || "Unknown location",
            distanceLabel,
          ].filter(Boolean).join(FIELD_SEPARATOR);
          card.appendChild(company);
          const status = document.createElement("p");
          status.className = "synergy-job-meta";
          const careerSleeveId = job.career_sleeve_id || job.primary_career_sleeve_id || "?";
          const careerSleeveScore = Number((job && job.career_sleeve_fit_score) ?? (job && job.primary_career_sleeve_score));
          const careerSleeveScoreText = Number.isFinite(careerSleeveScore) ? `${Math.round(careerSleeveScore * 10) / 10}/5` : "0/5";
          status.textContent = `${job.decision || "UNKNOWN"}${FIELD_SEPARATOR}Career Sleeve ${careerSleeveId} ${careerSleeveScoreText}`;
          card.appendChild(status);
          const confidence = document.createElement("p");
          confidence.className = "synergy-job-meta";
          confidence.textContent = formatConfidenceSummary(job);
          card.appendChild(confidence);
          const abroad = document.createElement("p");
          abroad.className = "synergy-job-meta";
          abroad.textContent = formatAbroadSummary(job);
          card.appendChild(abroad);
          const links = document.createElement("div");
          links.className = "synergy-job-links";
          const companyUrl = buildCompanyOpeningUrl(job);
          if (companyUrl) {
            const a = document.createElement("a");
            a.className = "synergy-link-btn";
            a.href = companyUrl;
            a.target = "_blank";
            a.rel = "noopener noreferrer";
            a.textContent = "Company URL";
            links.appendChild(a);
          }
          if (job.indeed_url) {
            const a = document.createElement("a");
            a.className = "synergy-link-btn";
            a.href = job.indeed_url;
            a.target = "_blank";
            a.rel = "noopener noreferrer";
            a.textContent = "Indeed URL";
            links.appendChild(a);
          }
          if (job.linkedin_url) {
            const a = document.createElement("a");
            a.className = "synergy-link-btn";
            a.href = job.linkedin_url;
            a.target = "_blank";
            a.rel = "noopener noreferrer";
            a.textContent = "LinkedIn URL";
            links.appendChild(a);
          }
          if (!links.childNodes.length) {
            const empty = document.createElement("span");
            empty.className = "synergy-empty";
            empty.textContent = "No outbound URLs available.";
            links.appendChild(empty);
          }
          card.appendChild(links);
          els.resultList.appendChild(card);
        });
      }

      function renderLoadDialogList() {
        els.loadDialogList.innerHTML = "";
        const query = String(state.loadFilter || "").trim().toLowerCase();
        const activeEditorKey = state.editorVisible
          ? (state.editor.mode === "edit" ? `edit:${normalizeLetter(state.editor.letter)}` : "add")
          : "";
        const groups = [
          { title: "FIXED CAREER SLEEVES (A-D)", items: state.catalog.fixed || [], scope: "fixed" },
          { title: "CUSTOM CAREER SLEEVES (E-Z)", items: state.catalog.custom || [], scope: "custom" },
        ];
        groups.forEach((group) => {
          const wrap = document.createElement("div");
          wrap.className = "synergy-dialog-group";
          const title = document.createElement("div");
          title.className = "synergy-dialog-group-title";
          title.textContent = group.title;
          wrap.appendChild(title);
          const filteredItems = (group.items || []).filter((sleeve) => {
            if (!query) return true;
            const hay = `${sleeve.letter || ""} ${sleeve.title || ""}`.toLowerCase();
            return hay.includes(query);
          });
          if (!filteredItems.length) {
            const empty = document.createElement("div");
            empty.className = "synergy-empty";
            empty.textContent = query ? "No matches in this group." : "No Career Sleeves in this group.";
            wrap.appendChild(empty);
          } else {
            filteredItems.forEach((sleeve) => {
              if (group.scope === "custom") {
                const sleeveBlock = document.createElement("div");
                sleeveBlock.className = "synergy-dialog-sleeve-block";
                const row = document.createElement("div");
                row.className = "synergy-dialog-option-row";
                const isActiveEdit = activeEditorKey === `edit:${normalizeLetter(sleeve.letter)}`;

                if (isActiveEdit) {
                  row.classList.add("synergy-dialog-option-row-active");
                  const { wrap } = createInlineTitleEditor(
                    sleeve.letter,
                    state.editor.title || sleeve.title || "",
                    (value) => {
                      state.editor.title = value;
                    },
                    () => {
                      saveDialogEditor().catch(() => setStatus("Could not save Career Sleeve.", "error"));
                    }
                  );
                  row.appendChild(wrap);
                } else {
                  const btn = createSplitSleeveButton(
                    sleeve.letter,
                    sleeve.title,
                    () => {
                      applySleeveToEditor(sleeve);
                      closeHeaderEditor();
                    }
                  );
                  row.appendChild(btn);
                }

                const actions = document.createElement("div");
                actions.className = "synergy-dialog-row-actions";
                if (isActiveEdit) {
                  const saveBtn = document.createElement("button");
                  saveBtn.type = "button";
                  saveBtn.className = "synergy-dialog-row-save";
                  saveBtn.textContent = getSaveButtonLabel();
                  saveBtn.title = getSaveButtonLabel();
                  saveBtn.addEventListener("click", () => {
                    saveDialogEditor().catch(() => setStatus("Could not save Career Sleeve.", "error"));
                  });
                  actions.appendChild(saveBtn);
                } else {
                  const editBtn = document.createElement("button");
                  editBtn.type = "button";
                  editBtn.className = "synergy-dialog-option-icon";
                  editBtn.textContent = ICON_EDIT;
                  editBtn.setAttribute("aria-label", `Edit title for Career Sleeve ${sleeve.letter}`);
                  editBtn.addEventListener("click", (event) => {
                    event.preventDefault();
                    event.stopPropagation();
                    startEditCustomSleeve(sleeve);
                  });
                  actions.appendChild(editBtn);

                  const deleteBtn = document.createElement("button");
                  deleteBtn.type = "button";
                  deleteBtn.className = "synergy-dialog-option-icon";
                  deleteBtn.textContent = ICON_REMOVE;
                  deleteBtn.setAttribute("aria-label", `Delete Career Sleeve ${sleeve.letter}`);
                  deleteBtn.addEventListener("click", (event) => {
                    event.preventDefault();
                    event.stopPropagation();
                    deleteCustomSleeveFromDialog(sleeve).catch(() => setStatus("Could not delete custom Career Sleeve.", "error"));
                  });
                  actions.appendChild(deleteBtn);
                }
                row.appendChild(actions);
                sleeveBlock.appendChild(row);

                if (isActiveEdit && els.dialogEditorSection) {
                  els.dialogEditorSection.classList.remove("is-hidden");
                  els.dialogEditorSection.classList.add("is-open");
                  sleeveBlock.appendChild(els.dialogEditorSection);
                }

                wrap.appendChild(sleeveBlock);
              } else {
                const btn = createSplitSleeveButton(
                  sleeve.letter,
                  sleeve.title,
                  () => {
                    applySleeveToEditor(sleeve);
                    closeHeaderEditor();
                  }
                );
                wrap.appendChild(btn);
              }
            });
          }
          if (group.scope === "custom") {
            const addBlock = document.createElement("div");
            addBlock.className = "synergy-dialog-sleeve-block";
            const addRow = document.createElement("div");
            addRow.className = "synergy-dialog-option-row";
            const isActiveAdd = activeEditorKey === "add";

            if (isActiveAdd) {
              addRow.classList.add("synergy-dialog-option-row-active");
              const { wrap } = createInlineTitleEditor(
                getNextCustomLetter(),
                state.editor.title || "",
                (value) => {
                  state.editor.title = value;
                },
                () => {
                  saveDialogEditor().catch(() => setStatus("Could not save Career Sleeve.", "error"));
                }
              );
              addRow.appendChild(wrap);

              const actions = document.createElement("div");
              actions.className = "synergy-dialog-row-actions";
              const saveBtn = document.createElement("button");
              saveBtn.type = "button";
              saveBtn.className = "synergy-dialog-row-save";
              saveBtn.textContent = getSaveButtonLabel();
              saveBtn.title = getSaveButtonLabel();
              saveBtn.addEventListener("click", () => {
                saveDialogEditor().catch(() => setStatus("Could not save Career Sleeve.", "error"));
              });
              actions.appendChild(saveBtn);
              addRow.appendChild(actions);
            } else {
              const addBtn = document.createElement("button");
              addBtn.type = "button";
              addBtn.className = "synergy-dialog-add-trigger";
              addBtn.textContent = "+";
              addBtn.setAttribute("aria-label", "Add custom Career Sleeve");
              addBtn.addEventListener("click", () => {
                resetDialogEditor("add", null, true);
                renderLoadDialogList();
                setTimeout(() => {
                  const input = els.loadDialogList.querySelector(".synergy-dialog-inline-title-input");
                  if (input) input.focus();
                }, 20);
              });
              addRow.appendChild(addBtn);
            }
            addBlock.appendChild(addRow);

            if (isActiveAdd && els.dialogEditorSection) {
              els.dialogEditorSection.classList.remove("is-hidden");
              els.dialogEditorSection.classList.add("is-open");
              addBlock.appendChild(els.dialogEditorSection);
            }
            wrap.appendChild(addBlock);
          }
          els.loadDialogList.appendChild(wrap);
        });
      }

      function resetDialogEditor(mode = "add", sleeve = null, visible = false) {
        if (mode === "edit" && sleeve) {
          state.editor.mode = "edit";
          state.editor.letter = normalizeLetter(sleeve.letter || "");
          state.editor.title = String(sleeve.title || "");
          state.editor.queries = dedupeQueries(sleeve.queries || []);
          state.editor.location_preferences = normalizeLocationPreferences(sleeve.location_preferences);
          state.editor.anchor = `edit:${state.editor.letter}`;
        } else {
          state.editor.mode = "add";
          state.editor.letter = "";
          state.editor.title = "";
          state.editor.queries = [];
          state.editor.location_preferences = defaultLocationPreferences();
          state.editor.anchor = "add";
        }
        setDialogEditorVisible(visible);
        renderDialogEditor();
      }

      function startEditCustomSleeve(sleeve) {
        const letter = normalizeLetter(sleeve ? sleeve.letter : "");
        if (!letter || !isCustomLetter(letter)) {
          setStatus("Only custom Career Sleeves (E-Z) can be edited.", "error");
          setDialogNote("Only custom Career Sleeves (E-Z) can be edited.", "error");
          return;
        }
        applySleeveToEditor(sleeve, { silent: true });
        resetDialogEditor("edit", sleeve, true);
        renderLoadDialogList();
        setDialogNote(
          `Editing Career Sleeve ${letter}. Update title and search queries, then save your changes.`,
          "info"
        );
        setTimeout(() => {
          const input = els.loadDialogList.querySelector(".synergy-dialog-inline-title-input");
          if (input) input.focus();
        }, 20);
      }

      function renderDialogEditor() {
        renderDialogQueries();
        syncDialogLocationInputs();
        if (!state.editorVisible) {
          setDialogNote("Click + to add a custom Career Sleeve.", "info");
          return;
        }
        const editor = collectEditor();
        if (editor.mode === "edit" && editor.letter) {
          setDialogNote(
            `Editing Career Sleeve ${editor.letter}. Update title and search queries, then save your changes.`,
            "info"
          );
          return;
        }
        setDialogNote(
          `Adding a new custom Career Sleeve. Next available letter: ${getNextCustomLetter()}. Add at least 1 search query, then save.`,
          "info"
        );
      }

      async function saveDialogEditor(options = {}) {
        const silent = Boolean(options.silent);
        setEditorLocationPreferencesFromInputs();
        const editor = collectEditor();
        if (!editor.title) {
          if (!silent) {
            setStatus("Type a Career Sleeve title before saving.", "error");
            setDialogNote("Title is required before you can save this Career Sleeve.", "error");
          }
          return null;
        }
        if (!editor.queries.length) {
          if (!silent) {
            setStatus("Add at least one search query before saving.", "error");
            setDialogNote("Add at least one search query before saving.", "error");
          }
          return null;
        }

        const payloadBody = {
          title: editor.title,
          queries: editor.queries,
          location_preferences: editor.location_preferences,
        };
        if (editor.mode === "edit" && isCustomLetter(editor.letter)) {
          payloadBody.letter = editor.letter;
          payloadBody.allow_overwrite = true;
        }

        const res = await fetch("/synergy-sleeves", {
          method: "POST",
          headers: { "Content-Type": "application/json", Accept: "application/json" },
          body: JSON.stringify(payloadBody),
        });
        const payload = await res.json();
        if (!res.ok) {
          if (!silent) {
            const errorMessage = payload.error || "Could not save Career Sleeve.";
            setStatus(errorMessage, "error");
            setDialogNote(errorMessage, "error");
          }
          return null;
        }

        state.catalog = payload.catalog || state.catalog;
        const saved = payload.saved || {};
        const wasEdit = editor.mode === "edit";
        applySleeveToEditor(saved, { silent: true });
        resetDialogEditor("add", null, false);
        renderLoadDialogList();
        if (!silent) {
          const successMessage = wasEdit
            ? `Saved edits to Career Sleeve ${saved.letter || "?"}.`
            : `Added custom Career Sleeve ${saved.letter || "?"}.`;
          setStatus(successMessage, "success");
          setDialogNote(successMessage, "success");
        }
        return saved;
      }

      async function deleteCustomSleeveFromDialog(sleeve) {
        const letter = normalizeLetter(sleeve ? sleeve.letter : "");
        if (!letter || !isCustomLetter(letter)) {
          setStatus("Only custom Career Sleeves (E-Z) can be deleted.", "error");
          setDialogNote("Only custom Career Sleeves (E-Z) can be deleted.", "error");
          return;
        }
        const confirmed = window.confirm(`Delete Career Sleeve ${letter}?`);
        if (!confirmed) {
          return;
        }

        const res = await fetch(`/synergy-sleeves/${encodeURIComponent(letter)}`, {
          method: "DELETE",
          headers: { Accept: "application/json" },
        });
        const payload = await res.json();
        if (!res.ok) {
          const errorMessage = payload.error || "Could not delete custom Career Sleeve.";
          setStatus(errorMessage, "error");
          setDialogNote(errorMessage, "error");
          return;
        }

        state.catalog = payload.catalog || state.catalog;
        if (normalizeLetter(state.current.letter) === letter) {
          const fallbackSleeve = findSleeveByLetter(loadLastLoadedSleeve()) || findSleeveByLetter("A");
          if (fallbackSleeve) {
            applySleeveToEditor(fallbackSleeve, { silent: true });
          } else {
            state.current.letter = "";
            state.current.title = "";
            state.current.queries = [];
            updateHeaderPreview();
          }
        }
        if (state.editor.mode === "edit" && normalizeLetter(state.editor.letter) === letter) {
          resetDialogEditor("add", null, false);
        }
        renderLoadDialogList();
        setStatus(`Deleted Career Sleeve ${letter}.`, "success");
        setDialogNote(`Deleted Career Sleeve ${letter} successfully.`, "success");
      }

      async function loadCatalog() {
        const res = await fetch("/synergy-sleeves", { headers: { Accept: "application/json" } });
        const payload = await res.json();
        if (!res.ok) throw new Error(payload.error || "Could not load Career Sleeves.");
        state.catalog = payload;
        renderLoadDialogList();
      }

      function selectInitialSleeve() {
        const rememberedLetter = loadLastLoadedSleeve();
        const rememberedSleeve = findSleeveByLetter(rememberedLetter);
        if (rememberedSleeve) {
          applySleeveToEditor(rememberedSleeve, { silent: true });
          return rememberedSleeve;
        }
        const defaultSleeveA = findSleeveByLetter("A");
        if (defaultSleeveA) {
          applySleeveToEditor(defaultSleeveA, { silent: true });
          return defaultSleeveA;
        }
        const firstAvailable = Array.isArray(state.catalog.all) && state.catalog.all.length ? state.catalog.all[0] : null;
        if (firstAvailable) {
          applySleeveToEditor(firstAvailable, { silent: true });
          return firstAvailable;
        }
        return null;
      }

      async function pollProgress(runId) {
        if (!runId) return;
        try {
          const res = await fetch(`/scrape-progress/${encodeURIComponent(runId)}?tail=120`, { headers: { Accept: "application/json" } });
          if (!res.ok) return;
          const payload = await res.json();
          renderEvents(payload.events || []);
          if (payload.summary) renderMetrics(payload.summary);
          if (payload.status === "done" || payload.status === "error") {
            clearInterval(state.progressTimer);
            state.progressTimer = null;
          }
        } catch (_error) {}
      }

      function setScrapeButtonsBusy(isBusy, variant = "default") {
        const defaultLabel = "Scrape Job Openings";
        const ultraLabel = "Scrape Ultra Fast";
        if (els.scrapeNowBtn) {
          els.scrapeNowBtn.disabled = !!isBusy;
          els.scrapeNowBtn.textContent = isBusy && variant === "default" ? "Scraping..." : defaultLabel;
        }
        if (els.scrapeUltraFastBtn) {
          els.scrapeUltraFastBtn.disabled = !!isBusy;
          els.scrapeUltraFastBtn.textContent = isBusy && variant === "ultra_fast" ? "Scraping..." : ultraLabel;
        }
      }

      async function runScrape(variant = "default") {
        const scrapeVariant = String(variant || "default").toLowerCase() === "ultra_fast" ? "ultra_fast" : "default";
        const variantLabel = scrapeVariant === "ultra_fast" ? "Ultra Fast" : "Default";
        if (state.scrapeBusy) {
          return setStatus("A scrape run is already in progress.", "error", "scrape");
        }
        const current = collectCurrent();
        if (!current.letter) return setStatus("Select or save a Career Sleeve before scraping.", "error", "scrape");
        if (!current.queries.length) return setStatus("Add at least one search query before scraping.", "error", "scrape");
        const effectiveSleeve = isFixedLetter(current.letter) ? current.letter : "E";
        const runId = `synergy-${Date.now().toString(36)}-${Math.random().toString(36).slice(2, 8)}`;
        state.scrapeBusy = true;
        setScrapeButtonsBusy(true, scrapeVariant);
        renderResults([]);
        renderMetrics(null);
        state.localProgressEvents = [];
        state.remoteProgressEvents = [];
        renderEvents();
        setStatus(
          `Starting ${variantLabel} scrape for Career Sleeve ${current.letter} (using scoring profile ${effectiveSleeve}).`,
          "info",
          "scrape"
        );
        if (state.progressTimer) clearInterval(state.progressTimer);
        state.progressTimer = setInterval(() => pollProgress(runId), 500);
        pollProgress(runId);

        const params = new URLSearchParams({
          run_id: runId,
          career_sleeve: effectiveSleeve,
          search_queries: current.queries.join(","),
          strict: "0",
          max_results: "200",
          scrape_variant: scrapeVariant,
        });
        if (!isFixedLetter(current.letter)) {
          params.set("custom_mode", "1");
          params.set("custom_letter", current.letter);
          const prefs = normalizeLocationPreferences(current.location_preferences);
          if (prefs.countries.length) {
            params.set("custom_geo_countries", prefs.countries.join(","));
          }
          if (prefs.regions.length) {
            params.set("custom_geo_regions", prefs.regions.join(","));
          }
          params.set("custom_abroad_min_percent", String(prefs.abroad_min_percent));
          params.set("custom_abroad_max_percent", String(prefs.abroad_max_percent));
        }

        try {
          const res = await fetch(`/scrape?${params.toString()}`, { headers: { Accept: "application/json" } });
          const payload = await res.json();
          if (!res.ok) {
            if (state.progressTimer) { clearInterval(state.progressTimer); state.progressTimer = null; }
            setStatus(payload.error || "Scrape failed.", "error", "scrape");
            return;
          }
          renderResults(payload.jobs || []);
          renderMetrics(payload.summary || null);
          const total = Array.isArray(payload.jobs) ? payload.jobs.length : 0;
          setStatus(`${variantLabel} scrape completed. Returned ${total} job openings.`, "success", "scrape");
        } catch (_error) {
          if (state.progressTimer) { clearInterval(state.progressTimer); state.progressTimer = null; }
          setStatus(`${variantLabel} scrape request failed.`, "error", "scrape");
        } finally {
          setTimeout(() => pollProgress(runId), 350);
          state.scrapeBusy = false;
          setScrapeButtonsBusy(false, scrapeVariant);
        }
      }

      function bindEvents() {
        els.closeLoadDialogBtn.addEventListener("click", closeHeaderEditor);
        if (els.loadDialogSearch) {
          els.loadDialogSearch.addEventListener("input", () => {
            state.loadFilter = String(els.loadDialogSearch.value || "");
            renderLoadDialogList();
          });
        }
        els.dialogAddQueryBtn.addEventListener("click", () => {
          const queryText = String(els.dialogQueryInput.value || "").trim();
          if (!queryText) return;
          state.editor.queries = dedupeQueries([...(state.editor.queries || []), queryText]);
          els.dialogQueryInput.value = "";
          renderDialogQueries();
          setDialogNote(`Added search query "${queryText}".`, "success");
        });
        els.dialogGenerateQueriesBtn.addEventListener("click", () => {
          generateQueriesFromEditorTitle();
        });
        els.dialogQueryInput.addEventListener("keydown", (event) => {
          if (event.key === "Enter") { event.preventDefault(); els.dialogAddQueryBtn.click(); }
        });
        els.dialogClearQueriesBtn.addEventListener("click", () => {
          state.editor.queries = [];
          renderDialogQueries();
          setDialogNote("Cleared all search queries for this editor.", "info");
        });
        if (els.dialogCountriesInput) {
          els.dialogCountriesInput.addEventListener("input", () => {
            state.editor.location_preferences = normalizeLocationPreferences({
              ...(state.editor.location_preferences || defaultLocationPreferences()),
              countries: parseCommaList(els.dialogCountriesInput.value),
            });
          });
        }
        if (els.dialogRegionsInput) {
          els.dialogRegionsInput.addEventListener("input", () => {
            state.editor.location_preferences = normalizeLocationPreferences({
              ...(state.editor.location_preferences || defaultLocationPreferences()),
              regions: parseCommaList(els.dialogRegionsInput.value),
            });
          });
        }
        if (els.dialogAbroadMinInput) {
          els.dialogAbroadMinInput.addEventListener("change", () => {
            setEditorLocationPreferencesFromInputs();
          });
        }
        if (els.dialogAbroadMaxInput) {
          els.dialogAbroadMaxInput.addEventListener("change", () => {
            setEditorLocationPreferencesFromInputs();
          });
        }
        els.scrapeNowBtn.addEventListener("click", () => runScrape("default"));
        if (els.scrapeUltraFastBtn) {
          els.scrapeUltraFastBtn.addEventListener("click", () => runScrape("ultra_fast"));
        }
        els.changeSleeveBtn.addEventListener("click", async () => {
          try {
            await loadCatalog();
            openHeaderEditor();
          } catch (error) {
            setStatus(error.message || "Could not open Career Sleeve dialog.", "error");
          }
        });
        els.loadDialog.addEventListener("cancel", (event) => {
          event.preventDefault();
          closeHeaderEditor();
        });
      }

      async function init() {
        bindEvents();
        resetDialogEditor("add", null, false);
        state.localProgressEvents = [
          {
            message: "Waiting for Career Sleeve selection.",
            type: "info",
            ts: new Date().toISOString(),
          },
        ];
        state.remoteProgressEvents = [];
        renderEvents();
        renderResults([]);
        renderMetrics(null);
        updateHeaderPreview();
        try {
          await loadCatalog();
          const initialSleeve = selectInitialSleeve();
          if (initialSleeve) {
            state.localProgressEvents = [
              {
                message: `Loaded Career Sleeve ${initialSleeve.letter}.`,
                type: "info",
                ts: new Date().toISOString(),
              },
            ];
            renderEvents();
          }
          setStatus("Catalog loaded. Use Change Career Sleeve to switch Career Sleeves.", "success");
        } catch (error) {
          setStatus(error.message || "Could not load Career Sleeve catalog.", "error");
        }
      }
      init();
    })();
  </script>
  <script src="{{ url_for('static', filename='script.js') }}"></script>
</body>
</html>

